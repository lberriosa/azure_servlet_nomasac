--SECUENCIAS
DROP SEQUENCE ID_TIPO_USUARIO_I;
DROP SEQUENCE ID_LOGIN_I;
DROP SEQUENCE ID_TIPO_PROFESIONAL_I;
DROP SEQUENCE ID_FOLIO_CONTRATO;
DROP SEQUENCE ID_SERVICIO;
DROP SEQUENCE ID_ACTIVIDAD;
DROP SEQUENCE ID_TIPO_ACTIVIDAD;
DROP SEQUENCE ID_FONDO_MONETARIO;
DROP SEQUENCE ID_PAGO;
DROP SEQUENCE ID_ASISTENCIA;
DROP SEQUENCE ID_CHECKLIST;
DROP SEQUENCE ID_ALERTA;
DROP SEQUENCE ID_REPORTE;
DROP SEQUENCE ID_MEJORA;
DROP SEQUENCE ID_APROBACION;
DROP SEQUENCE ID_INTERACCION;
DROP SEQUENCE ID_INFORME;

--PROCEDURES UNIVERSALES
DROP PACKAGE APP_USUARIO_SEGURIDAD;
DROP PROCEDURE VALIDAR_USUARIO;
DROP PROCEDURE VALIDAR_USUARIO_RUT;
DROP PROCEDURE VALIDAR_EMPRESA_C;
DROP PROCEDURE BUSCAR_USUARIO;
DROP PROCEDURE VISUALIZAR_USUARIO_CLIENTE;
DROP PROCEDURE VISUALIZAR_USUARIO_CLIENTE_CC;
DROP PROCEDURE VISUALIZAR_USUARIO_PROFESIONAL;
DROP PROCEDURE VISUALIZAR_USUARIO_CLIENTE_RC;
DROP PROCEDURE VISUALIZAR_USUARIO_CLIENTE_R;
DROP PROCEDURE VISUALIZAR_INFO_CONTRATO;
DROP PROCEDURE VISUALIZAR_INFO_CONTRATO_FO;
DROP PROCEDURE VISUALIZAR_INFO_CONTRATO_US;
DROP PROCEDURE VISUALIZAR_INFO_SERVICIO;
DROP PROCEDURE VISUALIZAR_INFO_SERVICIO_IS;
DROP PROCEDURE VISUALIZAR_INFO_SERVICIO_US;
DROP PROCEDURE VISUALIZAR_INFO_SERVICIOP_US;
DROP PROCEDURE VISUALIZAR_HISTORICO_PAGO_S;
DROP PROCEDURE VISUALIZAR_DETALLE_PAGO_PEND;
DROP PROCEDURE VISUALIZAR_FONDO_USUARIO;
DROP PROCEDURE VISUALIZAR_FONDO;
DROP PROCEDURE VISUALIZAR_CLIENTES_SC;
DROP PROCEDURE VISUALIZAR_CLIENTES_CC;
DROP PROCEDURE VISUALIZAR_CLIENTES_CCA;
DROP PROCEDURE VISUALIZAR_SERVICIOS_C;
DROP PROCEDURE VISUALIZAR_SERVICIOS_CXID;
DROP PROCEDURE VISUALIZAR_PCLIENTE_CONTRATO;
DROP PROCEDURE VISUALIZAR_FONDO_PCONTRATO;
DROP PROCEDURE VISUALIZAR_FONDO_PU;
DROP PROCEDURE BUSCAR_SERVICIOC_XU;
DROP PROCEDURE BUSCAR_PROFESION_XU;
DROP PROCEDURE BUSCAR_PAGOS_XU;
DROP PROCEDURE BUSCAR_PAGOS_XID;
DROP PROCEDURE BUSCAR_PAGOS_XAD;
DROP PROCEDURE BUSCAR_FONDOS_XAD;
DROP PROCEDURE BUSCAR_USUARIO_PROFE;
DROP PROCEDURE BUSCAR_VISITA_XUF;
DROP PROCEDURE BUSCAR_VISITA_XUM;
DROP PROCEDURE BUSCAR_VISITA;
DROP PROCEDURE BUSCAR_VISITA_XRUT;
DROP PROCEDURE BUSCAR_VISITA_XIDA;
DROP PROCEDURE BUSCAR_RCVISITA_XA;
DROP PROCEDURE BUSCAR_PAGOP_XIDU;
DROP PROCEDURE BUSCAR_PAGOP_XIDS;
DROP PROCEDURE BUSCAR_ARCHIVO_XID;
DROP PROCEDURE BUSCAR_ARCHIVOAC_XID;
DROP PROCEDURE BUSCAR_ARCHIVOFI_XID;
DROP PROCEDURE VISUALIZAR_ASISTENCIASA;
DROP PROCEDURE VISUALIZAR_INFO_SERVICIO_R;
DROP PROCEDURE VISUALIZAR_HISTORICO_PAGO_SR;
DROP PROCEDURE VISUALIZAR_ACTIVIDAD;
DROP PROCEDURE VISUALIZAR_ACCIDENTES_UW;
DROP PROCEDURE VISUALIZAR_ACCIDENTES_XID;
DROP PROCEDURE VISUALIZAR_FISCALIZACION_UW;
DROP PROCEDURE VISUALIZAR_FISCALIZACION_XID;
DROP PROCEDURE VISUALIZAR_ALERTA_XID;
DROP PROCEDURE BUSCAR_ALERTAS_XA;
DROP PROCEDURE BUSCAR_ACTIVIDADES_EMXFID;
DROP PROCEDURE BUSCAR_MEJORAS_PROFES;
DROP PROCEDURE BUSCAR_MEJORAS_PROFXID;
DROP PROCEDURE BUSCAR_MEJORAS_ADMIN;
DROP PROCEDURE BUSCAR_MEJORAS_XRUT;
DROP PROCEDURE VISUALIZAR_USUA_PROFES_ACT;
DROP PROCEDURE VISUALIZAR_PROF_CHAT_XID; 
DROP PROCEDURE VISUALIZAR_PROF_CHAT;
DROP PROCEDURE VISUALIZAR_CHAT_XIDAP; 
DROP PROCEDURE VISUALIZAR_CHAT_XIDAC; 
DROP PROCEDURE VISUALIZAR_USER_CHAT_XID; 
DROP PROCEDURE VISUALIZAR_ADMIN_CHAT_XID;
DROP PROCEDURE BUSCAR_CAPACIAID_XA;
DROP PROCEDURE BUSCAR_CAPACITACION;
DROP PROCEDURE BUSCAR_CAPACITA_XRUT;
DROP PROCEDURE BUSCAR_CAPACITA_XIDA;
DROP PROCEDURE BUSCAR_INFORMECA_XID;
DROP PROCEDURE VISUALIZAR_ACTIVIDAD_ID;
DROP PROCEDURE VISUALIZAR_ESTADISTICA;
DROP PROCEDURE VISUALIZAR_VISITA;
DROP PROCEDURE VISUALIZAR_CHECKLIST;
DROP PROCEDURE VISUALIZAR_ACC;

--PROCEDURE ESTADISTICA WEB
DROP PROCEDURE CANTIDAD_ACTIVIDAD_XM;
DROP PROCEDURE ESTA_TOTAL_VISITAS_ADM;
DROP PROCEDURE ESTA_TOTAL_CAPACI_ADM;
DROP PROCEDURE ESTA_TOTAL_ALERT_ADM;
DROP PROCEDURE ESTA_TOTAL_ASIS_ADM;
DROP PROCEDURE ESTA_TOTAL_USUA_ADM;
DROP PROCEDURE ESTA_TOTAL_CCREA_ADM;
DROP PROCEDURE ESTA_TOTAL_PAGOS_ADM;
DROP PROCEDURE ESTA_TOTAL_PXMES_ADM;
DROP PROCEDURE ESTA_RENDIM_LAB_ADM;
DROP PROCEDURE ESTA_TOTAL_MEJORS_ADM;
DROP PROCEDURE ESTA_TOTAL_PROF_ADM;
DROP PROCEDURE ESTA_TOTAL_INAS_ADM;
DROP PROCEDURE ESTA_TOTAL_ACT_ADM;
DROP PROCEDURE ESTA_T_ACTXM_CLI; 
DROP PROCEDURE ESTA_T_VISIT_CLI; 
DROP PROCEDURE ESTA_T_CAPACI_CLI; 
DROP PROCEDURE ESTA_T_ALERT_CLI; 
DROP PROCEDURE ESTA_T_ASISTE_CLI;
DROP PROCEDURE ESTA_T_PROA_CLI;
DROP PROCEDURE ESTA_T_ACXMES_CLI;
DROP PROCEDURE ESTA_TACTI_SUPE; 
DROP PROCEDURE ESTA_TVISI_SUPE; 
DROP PROCEDURE ESTA_TACCI_SUPE; 
DROP PROCEDURE ESTA_TFIS_SUPE; 
DROP PROCEDURE ESTA_TMEJO_SUPE; 
DROP PROCEDURE ESTA_TASIS_SUPE; 
DROP PROCEDURE ESTA_CASIS_SUPE; 
DROP PROCEDURE ESTA_TUSER_SUPE; 
DROP PROCEDURE ESTA_CCONT_SUPE;
DROP PROCEDURE ESTA_T_CAPXM_CAP; 
DROP PROCEDURE ESTA_T_CAPAC_CAP; 
DROP PROCEDURE ESTA_T_CAPACF_CAP; 
DROP PROCEDURE ESTA_T_ASIXM_CAP; 
DROP PROCEDURE ESTA_T_CAPAR_CAP;
DROP PROCEDURE ESTA_T_INTERAXM_ASI; 
DROP PROCEDURE ESTA_T_INTERA_ASI;
DROP PROCEDURE ESTA_T_APROBA_ASI;
DROP PROCEDURE ESTA_P_XMES_CLI; 
DROP PROCEDURE ESTA_T_FONDOS_CLI; 
DROP PROCEDURE ESTA_T_PAGADO_CLI; 
DROP PROCEDURE ESTA_T_DEBE_CLI; 
DROP PROCEDURE ESTA_T_CPAGADA_CLI; 

--PROCEDURES WEB
DROP PROCEDURE CAMBIAR_CONTRASE헤_W;
DROP PROCEDURE CREAR_USUARIO_W;
DROP PROCEDURE CREAR_USUARIO_PROFESIONAL_W;
DROP PROCEDURE CREAR_USUARIO_CLIENTE_W;
DROP PROCEDURE MODIFICAR_USUARIO_CLIENTE_E_W;
DROP PROCEDURE MODIFICAR_ESTADO_USUARIO_W;
DROP PROCEDURE MODIFICAR_USUARIO_W;
DROP PROCEDURE MODIFICAR_PROFESION_USUARIO_W;
DROP PROCEDURE CREAR_CONTRATO_W;
DROP PROCEDURE CREAR_SERVICIO_CONTRATO_W;
DROP PROCEDURE CREAR_FONDO_MONETARIO_W;
DROP PROCEDURE CREAR_PAGO_SERVICIO_W;
DROP PROCEDURE EDITAR_ESTADO_CONTRATO_W;
DROP PROCEDURE EDITAR_ESTADO_CONTRATOU_W;
DROP PROCEDURE EDITAR_SERVICIO_W;
DROP PROCEDURE EDITAR_FONDO_MONETARIO_W;
DROP PROCEDURE EDITAR_SERVICIOC_W;
DROP PROCEDURE CREAR_ACTIVIDAD_COMPLETA_W;
DROP PROCEDURE EDITAR_CANCELAR_VISITA_W;
DROP PROCEDURE CREAR_SERVICIO_PEX_W;
DROP PROCEDURE EDITAR_FECHA_VISITA_W;
DROP PROCEDURE CREAR_ASISTENCIA_AID_W;
DROP PROCEDURE EDITAR_ESTADO_ACTIVID_W;
DROP PROCEDURE CREAR_PAGO_W;
DROP PROCEDURE EDITAR_SERVICIOPE_W;
DROP PROCEDURE EDITAR_FIN_VISITA_W;
DROP PROCEDURE CREAR_CHECKLIST_V_W;
DROP PROCEDURE CREAR_REPORTE_V_W;
DROP PROCEDURE CREAR_ALERTA_AF_W;
DROP PROCEDURE EDITAR_ACTIVIDAD_ALVI_W;
DROP PROCEDURE EDITAR_ALERTA_ALVI_W;
DROP PROCEDURE EDITAR_CANCELAR_ALERTA_W;
DROP PROCEDURE EDITAR_ESTADO_SERVICIO_W;
DROP PROCEDURE CREAR_MEJORA_W;
DROP PROCEDURE EDITAR_MEJORA_CANCEL_W;
DROP PROCEDURE EDITAR_MEJORA_APROBAR_W;
DROP PROCEDURE CREAR_ACTIVIDAD_CCHAT_W;
DROP PROCEDURE EDITAR_CERRAR_CHAT_W;
DROP PROCEDURE EDITAR_CANCELAR_CAPACITA_W;
DROP PROCEDURE CREAR_INFORME_C_W;

--PROCEDURES ESCRITORIO
DROP PROCEDURE CREAR_USUARIO_E;
DROP PROCEDURE CREAR_USUARIO_PROFESIONAL_E;
DROP PROCEDURE CREAR_USUARIO_CLIENTE_E;
DROP PROCEDURE CAMBIAR_CONTRASE헤_E;
DROP PROCEDURE MODIFICAR_USUARIO_CLIENTE_E_E;
DROP PROCEDURE MODIFICAR_ESTADO_USUARIO_E;
DROP PROCEDURE MODIFICAR_USUARIO_E;
DROP PROCEDURE MODIFICAR_USUARIO_PROFESION_E;
DROP PROCEDURE CREAR_CONTRATO_E;
DROP PROCEDURE CREAR_SERVICIO_CONTRATO_E;
DROP PROCEDURE CREAR_FONDO_MONETARIO_E;
DROP PROCEDURE EDITAR_ESTADO_CONTRATOU_E;
DROP PROCEDURE EDITAR_SERVICIO_E;
DROP PROCEDURE EDITAR_ACTIVIDAD_E;
DROP PROCEDURE VALIDAR_USUARIO_RUT_E;
DROP PROCEDURE VALIDAR_USUARIO_RUT_E_E;
DROP PROCEDURE VALIDAR_USUARIO_HAB_E;
DROP PROCEDURE VALIDAR_CONTRATO_E;
DROP PROCEDURE VALIDAR_FMONETARIO_E;
DROP PROCEDURE VALIDAR_ESTADO_CONTRATO_E;
DROP PROCEDURE EDITAR_CONTRATO_E_E;
DROP PROCEDURE EDITAR_CONTRATO_E_A_E;
DROP PROCEDURE EDITAR_ACTIVIDAD_E_E;
DROP PROCEDURE EDITAR_ACTIVIDAD_E_C_E;
DROP PROCEDURE EDITAR_SERVICIO_E_E;
DROP PROCEDURE EDITAR_SERVICIO_E_A_E;
DROP PROCEDURE VALIDAR_ESTADO_SERVICIO_H_E;
DROP PROCEDURE EDITAR_SERVICIO_P_E;
DROP PROCEDURE DATOS_ESTADISTICA_E;
DROP PROCEDURE DATOS_ESTADISTICA_1E;
DROP PROCEDURE DATOS_ESTADISTICA_2E;
DROP PROCEDURE DATOS_ESTADISTICA_3E;
DROP PROCEDURE DATA_INFORME_PDF;
DROP PROCEDURE VALIDAR_REPORTE_E;
DROP PROCEDURE CREAR_ACTIVIDAD_COMPLETA_E;
DROP PROCEDURE EDITAR_FECHA_VISITA_E; 
DROP PROCEDURE ELIMINAR_VISITA_E;
DROP PROCEDURE CREAR_ACTIVIDAD_COMPLETA_R;
DROP PROCEDURE CAL_ACCIDEN;

-- VERSION UNIVERSAL 
-- SECUENCIAS 

CREATE SEQUENCE ID_TIPO_USUARIO_I;
CREATE SEQUENCE ID_LOGIN_I;
CREATE SEQUENCE ID_TIPO_PROFESIONAL_I;
CREATE SEQUENCE ID_FOLIO_CONTRATO;
CREATE SEQUENCE ID_SERVICIO;
CREATE SEQUENCE ID_ACTIVIDAD;
CREATE SEQUENCE ID_TIPO_ACTIVIDAD;
CREATE SEQUENCE ID_FONDO_MONETARIO;
CREATE SEQUENCE ID_PAGO;
CREATE SEQUENCE ID_ASISTENCIA;
CREATE SEQUENCE ID_CHECKLIST;
CREATE SEQUENCE ID_ALERTA;
CREATE SEQUENCE ID_REPORTE;
CREATE SEQUENCE ID_MEJORA;
CREATE SEQUENCE ID_APROBACION;
CREATE SEQUENCE ID_INTERACCION;
CREATE SEQUENCE ID_INFORME;

-- CREACION DE PACKAGE CON FUNCIONES RELACIONADAS FUNCION DE ENCRIPTACION
CREATE OR REPLACE PACKAGE APP_USUARIO_SEGURIDAD AS
  
  FUNCTION GET_HASH (U_USUARIO  IN  VARCHAR2,
                     U_CONTRASE헤  IN  VARCHAR2)
  RETURN VARCHAR2;
  
  FUNCTION GET_IDT (U_USUARIO IN VARCHAR2)
  RETURN NUMBER;
  
  FUNCTION GET_FOLIO(U_ID_USUARIO IN NUMBER)
  RETURN NUMBER;
  
  FUNCTION GET_TACTIVIDAD(U_ID_ACTIV IN NUMBER)
  RETURN NUMBER;
  
  FUNCTION GET_IDPROFESION(U_USUARIO IN VARCHAR2)
  RETURN NUMBER;
                         
END;
/

-- PACKAGE BODY CON FUNCIONES A REALIZAR
CREATE OR REPLACE PACKAGE BODY APP_USUARIO_SEGURIDAD AS
    
   -- FUNCION QUE ENCRIPTA CONTRASE헤S 
  FUNCTION GET_HASH (U_USUARIO  IN  VARCHAR2,
                     U_CONTRASE헤  IN  VARCHAR2)
    RETURN VARCHAR2 AS
    L_SALT VARCHAR2(30) := 'ORACLE';
     BEGIN
        RETURN DBMS_CRYPTO.HASH(UTL_RAW.CAST_TO_RAW(UPPER(U_USUARIO) || L_SALT || UPPER(U_CONTRASE헤)),DBMS_CRYPTO.HASH_SH1);
     END;
     
   --FUNCION QUE RETORNA ID_TIPO_USUARIO EN BASE A RUT
  FUNCTION GET_IDT (U_USUARIO IN VARCHAR2)
  RETURN NUMBER IS
  IDE_USUARIO TIPO_USUARIO.ID_TIPO_USUARIO%TYPE;
  BEGIN
  SELECT T.ID_TIPO_USUARIO
  INTO IDE_USUARIO
  FROM TIPO_USUARIO T JOIN LOGIN L ON T.ID_TIPO_USUARIO = L.ID_TIPO_USUARIO
  WHERE T.RUT_USUARIO = U_USUARIO; 
  
  RETURN IDE_USUARIO;
  END GET_IDT;
  
  --FUNCION QUE RETORNA EL FOLIO DEL CONTRATO EN BASE A UN ID 
  FUNCTION GET_FOLIO(U_ID_USUARIO IN NUMBER)
  RETURN NUMBER IS 
  NUM_FOLIO CONTRATO.FOLIO_CONTRATO%TYPE;
  BEGIN
  SELECT FOLIO_CONTRATO
  INTO NUM_FOLIO 
  FROM CONTRATO 
  WHERE ID_TIPO_USUARIO = U_ID_USUARIO;
  
  RETURN NUM_FOLIO;
  END GET_FOLIO;
  
  --FUNCION QUE RETORNA ID DE ACTIVIDAD
  FUNCTION GET_TACTIVIDAD(U_ID_ACTIV IN NUMBER)
  RETURN NUMBER IS 
  TIPO_ACT TIPO_ACTIVIDAD.ID_TIPO_ACTIVIDAD%TYPE;
  BEGIN
  SELECT ID_ACTIVIDAD
  INTO TIPO_ACT 
  FROM TIPO_ACTIVIDAD 
  WHERE ID_ACTIVIDAD = U_ID_ACTIV;
  
  RETURN TIPO_ACT;
  END GET_TACTIVIDAD;
  
  --FUNCION QUE RETORNA ID DE PROFESION
  FUNCTION GET_IDPROFESION(U_USUARIO IN VARCHAR2)
  RETURN NUMBER IS
  TIPO_PRO PROFESION.ID_PROFESION%TYPE;
  BEGIN
  SELECT P.ID_PROFESION 
  INTO TIPO_PRO
  FROM USUARIO U 
  JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO
  JOIN PROFESION P ON T.ID_TIPO_USUARIO = P.ID_TIPO_USUARIO
  WHERE U.RUT_USUARIO = U_USUARIO;
  
  RETURN TIPO_PRO;
  END GET_IDPROFESION;
  
END;
/

-- PERMITE VALIDAR ID DE USUARIO Y CONTRASE헤
CREATE OR REPLACE PROCEDURE VALIDAR_USUARIO(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, OUT_CURSOR_USUARIO OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_USUARIO FOR
        SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.HABILITADO,T.TIPO
        FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO
                       JOIN LOGIN L ON T.ID_TIPO_USUARIO = L.ID_TIPO_USUARIO
        WHERE U.RUT_USUARIO = IN_USUARIO AND L.CONTRASE헤_USUARIO = APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO, IN_CONTRASE헤);
    END;
/

-- VALIDAR SI EXISTE EMPRESA
CREATE OR REPLACE PROCEDURE VALIDAR_EMPRESA_C(IN_EMPRESA IN VARCHAR2,OUT_CURSOR_EMPRESA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_EMPRESA FOR
  SELECT RUT_EMPRESA 
  FROM EMPRESA
  WHERE RUT_EMPRESA = IN_EMPRESA; 
END;
/

-- PERMITE VALIDAR USUARIO EXISTENTE POR SU ID
CREATE OR REPLACE PROCEDURE VALIDAR_USUARIO_RUT(IN_USUARIO IN VARCHAR2, OUT_CURSOR_USUARIO OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_USUARIO FOR
        SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.HABILITADO,T.TIPO
        FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO
                       JOIN LOGIN L ON T.ID_TIPO_USUARIO = L.ID_TIPO_USUARIO
        WHERE U.RUT_USUARIO = IN_USUARIO;
    END;
/

-- PERMITE LA BUSQUEDA DE USUARIO -- USADO EN SESION 
CREATE OR REPLACE PROCEDURE BUSCAR_USUARIO(IN_USUARIO IN VARCHAR2, OUT_CURSOR_USUARIO OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_USUARIO FOR
            SELECT NOMBRE_USUARIO,APELLIDO_USUARIO,DOMICILIO_USUARIO,TELEFONO_USUARIO,CORREO_USUARIO
            FROM USUARIO
            WHERE RUT_USUARIO = IN_USUARIO;
    END;
/


-- VISUALIZA DATOS GENERALES DE CLIENTE
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUARIO_CLIENTE(OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CLIENTE FOR
 SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,U.DOMICILIO_USUARIO,U.HABILITADO,
        E.RUT_EMPRESA,E.RAZON_SOCIAL_EMPRESA,E.DIRECCION_EMPRESA,E.TELEFONO_EMPRESA,E.CORREO_EMPRESA,E.PAGINA_WEB_EMPRESA,T.TIPO
 FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO 
                JOIN EMPRESA E ON U.RUT_USUARIO = E.RUT_USUARIO 
 WHERE TIPO = 'Cliente';
END;
/

-- VISUALIZA DATOS DE CLIENTE CON CONTRATO
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUARIO_CLIENTE_CC(OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CLIENTE FOR
 SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,U.DOMICILIO_USUARIO,U.HABILITADO,
        E.RUT_EMPRESA,E.RAZON_SOCIAL_EMPRESA,E.DIRECCION_EMPRESA,E.TELEFONO_EMPRESA,E.CORREO_EMPRESA,E.PAGINA_WEB_EMPRESA,T.TIPO
 FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO 
                JOIN CONTRATO C ON T.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
                JOIN EMPRESA E ON U.RUT_USUARIO = E.RUT_USUARIO 
 WHERE TIPO = 'Cliente';
END;
/

-- VISUALIZA DATOS GENERALES DE PROFESIONALES
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUARIO_PROFESIONAL(OUT_CURSOR_PROFESIONAL OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_PROFESIONAL FOR
 SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,U.DOMICILIO_USUARIO,U.HABILITADO,
       P.NOMBRE_PROFESION
 FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO   
                JOIN PROFESION P ON T.ID_TIPO_USUARIO = P.ID_TIPO_USUARIO
 WHERE TIPO = 'Profesional';
END;
/

-- VISUALIZAR DATOS DE CLIENTE POR RUT - CLIENTE
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUARIO_CLIENTE_RC(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
  SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,U.DOMICILIO_USUARIO,U.HABILITADO,
        E.RUT_EMPRESA,E.RAZON_SOCIAL_EMPRESA,E.DIRECCION_EMPRESA,E.TELEFONO_EMPRESA,E.CORREO_EMPRESA,E.PAGINA_WEB_EMPRESA,T.TIPO
 FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO 
                JOIN EMPRESA E ON U.RUT_USUARIO = E.RUT_USUARIO
 WHERE U.RUT_USUARIO =IN_USUARIO ; 
END;
/

-- VISUALIZAR DATOS DE CLIENTE POR RUT
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUARIO_CLIENTE_R(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
  SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,U.DOMICILIO_USUARIO,U.HABILITADO,
        E.RUT_EMPRESA,E.RAZON_SOCIAL_EMPRESA,E.DIRECCION_EMPRESA,E.TELEFONO_EMPRESA,E.CORREO_EMPRESA,E.PAGINA_WEB_EMPRESA,T.TIPO
 FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO 
                JOIN EMPRESA E ON U.RUT_USUARIO = E.RUT_USUARIO
 WHERE U.RUT_USUARIO =IN_USUARIO ; 
END;
/

-- VISUALIZAR DATOS DE CLIENTE POR RUT - PROFESIONAL 
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUARIO_CLIENTE_RP(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
  SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,U.DOMICILIO_USUARIO,U.HABILITADO,
         P.NOMBRE_PROFESION,T.TIPO
 FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO   
                JOIN PROFESION P ON T.ID_TIPO_USUARIO = P.ID_TIPO_USUARIO
 WHERE U.RUT_USUARIO =IN_USUARIO ; 
END;
/


-- VISUALIZAR INFO DE CONTRATO.
CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_CONTRATO(OUT_CURSOR_CONTRATO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CONTRATO FOR
SELECT FOLIO_CONTRATO, ID_TIPO_USUARIO,FECHA_CONTRATO,PLAZO_CONTRATO,MONTO_PAGO,MODIFICADO,ESTADO  
FROM CONTRATO;
END;
/

-- VISUALIZAR DETALLE DE CONTRATO X FOLIO DE CONTRATO

CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_CONTRATO_FO(IN_FOLIO IN NUMBER,OUT_CURSOR_CONTRATO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CONTRATO FOR
SELECT FOLIO_CONTRATO, ID_TIPO_USUARIO,FECHA_CONTRATO,PLAZO_CONTRATO,MONTO_PAGO,MODIFICADO,ESTADO  
FROM CONTRATO
WHERE FOLIO_CONTRATO = IN_FOLIO;
END;
/


-- VISUALIZAR CONTRATO X USUARIO.

CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_CONTRATO_US(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CONTRATO OUT SYS_REFCURSOR)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);

BEGIN
OPEN OUT_CURSOR_CONTRATO FOR
SELECT FOLIO_CONTRATO, ID_TIPO_USUARIO,FECHA_CONTRATO,PLAZO_CONTRATO,MONTO_PAGO,MODIFICADO,ESTADO  
FROM CONTRATO
WHERE FOLIO_CONTRATO = F_CON;
END;
/


-- VISUALIZAR INFO DE SERVICIOS
CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_SERVICIO(OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT ID_SERVICIO,FOLIO_CONTRATO,NOMBRE_SERVICIO,VALOR_SERVICIO,DESCRIPCION_SERVICIO,FECHA_INICIO,FECHA_TERMINO,ESTADO,PAGADO
FROM SERVICIO;
END;
/

-- VISUALIZAR DETALLE DE SERVICIOS X ID DE SERVICIO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_SERVICIO_IS(IN_SERVICIO IN NUMBER,OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT ID_SERVICIO,FOLIO_CONTRATO,NOMBRE_SERVICIO,VALOR_SERVICIO,DESCRIPCION_SERVICIO,FECHA_INICIO,FECHA_TERMINO,ESTADO,PAGADO
FROM SERVICIO
WHERE ID_SERVICIO = IN_SERVICIO;
END;
/

-- VISUALIZAR INFO DE SERVICIOS X USUARIO (SE USA FOLIO DE CONTRATO POR RELACION)
CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_SERVICIO_US(IN_USUARIO IN VARCHAR2,OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT ID_SERVICIO,FOLIO_CONTRATO,NOMBRE_SERVICIO,VALOR_SERVICIO,DESCRIPCION_SERVICIO,FECHA_INICIO,FECHA_TERMINO,ESTADO,PAGADO
FROM SERVICIO
WHERE FOLIO_CONTRATO = F_CON;
END;
/


-- VISUALIZAR HISTORICO DE PAGOS Y SERVICIOS X USUARIO
CREATE OR REPLACE PROCEDURE VISUALIZAR_INFO_SERVICIOP_US(IN_USUARIO IN VARCHAR2,OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,
       S.FECHA_TERMINO,S.ESTADO,S.PAGADO,P.VALOR_TOTAL,P.FECHA_PAGO,P.ID_PAGO
FROM SERVICIO S JOIN PAGO P ON S.ID_SERVICIO = P.ID_SERVICIO
WHERE FOLIO_CONTRATO = F_CON;
END;
/


-- VISUALIZAR HISTORICO DE PAGOS Y SERVICIOS 
CREATE OR REPLACE PROCEDURE VISUALIZAR_HISTORICO_PAGO_S(OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_PAGO FOR
SELECT S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,
       S.FECHA_TERMINO,S.ESTADO,S.PAGADO,P.VALOR_TOTAL,P.FECHA_PAGO,P.ID_PAGO
FROM SERVICIO S JOIN PAGO P ON S.ID_SERVICIO = P.ID_SERVICIO;
END;
/

-- VISUALIZAR PAGOS X SERVICIOS PENDIENTES - SERVICIO HABILITADO
CREATE OR REPLACE PROCEDURE VISUALIZAR_DETALLE_PAGO_PEND(OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_PAGO FOR
SELECT S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,
       S.FECHA_TERMINO,S.ESTADO,S.PAGADO,P.VALOR_TOTAL,P.FECHA_PAGO,P.ID_PAGO
FROM SERVICIO S JOIN PAGO P ON S.ID_SERVICIO = P.ID_SERVICIO
WHERE S.PAGADO = 0 AND S.ESTADO = 1;
END;
/

-- VISUALIZAR HISTORICO DE FONDO MONETARIO POR CONTRATO Y USUARIO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_FONDO_USUARIO(IN_USUARIO IN VARCHAR2,OUT_CURSOR_FONDO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_FONDO FOR
SELECT F.ID_FONDO, F.FOLIO_CONTRATO, F.MONTO_ABONO, F.FECHA_ABONO,
       T.ID_TIPO_USUARIO,T.FECHA_CONTRATO,T.PLAZO_CONTRATO,T.MONTO_PAGO,T.MODIFICADO,ESTADO,
       I.RUT_USUARIO
FROM FONDO_MONETARIO F JOIN CONTRATO T ON F.FOLIO_CONTRATO = T.FOLIO_CONTRATO
                       JOIN TIPO_USUARIO I ON T.ID_TIPO_USUARIO = I.ID_TIPO_USUARIO
WHERE I.RUT_USUARIO = IN_USUARIO;
END;
/

-- VISUALIZAR HISTORICO DE FONDO MONETARIO Y CONTRATO X USUARIO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_FONDO(OUT_CURSOR_FONDO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_FONDO FOR
SELECT F.ID_FONDO, F.FOLIO_CONTRATO, F.MONTO_ABONO, F.FECHA_ABONO,
       T.ID_TIPO_USUARIO,T.FECHA_CONTRATO,T.PLAZO_CONTRATO,T.MONTO_PAGO,T.MODIFICADO,ESTADO,
       I.RUT_USUARIO
FROM FONDO_MONETARIO F JOIN CONTRATO T ON F.FOLIO_CONTRATO = T.FOLIO_CONTRATO
                       JOIN TIPO_USUARIO I ON T.ID_TIPO_USUARIO = I.ID_TIPO_USUARIO;
END;
/


-- VISUALIZAR CLIENTES SIN CONTRATO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_CLIENTES_SC(OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
SELECT C.FOLIO_CONTRATO,U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.CORREO_USUARIO
FROM CONTRATO C FULL JOIN TIPO_USUARIO T  ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE TIPO = 'Cliente' AND C.FOLIO_CONTRATO IS NULL AND U.HABILITADO = 1;
END;
/


-- VISUALIZAR CLIENTES CON CONTRATO ACTIVO
CREATE OR REPLACE PROCEDURE VISUALIZAR_CLIENTES_CCA(OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
SELECT C.FOLIO_CONTRATO,U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.CORREO_USUARIO
FROM CONTRATO C FULL JOIN TIPO_USUARIO T  ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE TIPO = 'Cliente' AND C.FOLIO_CONTRATO IS NOT NULL AND U.HABILITADO = 1 AND C.ESTADO = 1;
END;
/

--VISUALIZAR CLIENTES Y SU CONTRATO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_CLIENTES_CC(OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
SELECT C.FOLIO_CONTRATO, FECHA_CONTRATO,PLAZO_CONTRATO,MONTO_PAGO,MODIFICADO,ESTADO,U.RUT_USUARIO,
     U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.CORREO_USUARIO
FROM CONTRATO C FULL JOIN TIPO_USUARIO T  ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE TIPO = 'Cliente' AND C.FOLIO_CONTRATO IS NOT NULL; 
END;
/

--VISUALIZAR TODOS LOS SERVICIO-CLIENTE ASOCIADO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_SERVICIOS_C(OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT U.RUT_USUARIO,S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,S.FECHA_TERMINO,S.ESTADO,S.PAGADO
FROM SERVICIO S JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO JOIN TIPO_USUARIO T  ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO;
END;
/

--VISUALIZAR SERVICIOS X ID DE CLIENTE
CREATE OR REPLACE PROCEDURE VISUALIZAR_SERVICIOS_CXID(IN_USUARIO IN VARCHAR2,OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT U.RUT_USUARIO,S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,S.FECHA_TERMINO,S.ESTADO,S.PAGADO
FROM SERVICIO S JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO JOIN TIPO_USUARIO T  ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE U.RUT_USUARIO = IN_USUARIO;
END;
/

-- VERIFICAR USUARIO CLIENTE ESTADO CONTRATO 

CREATE OR REPLACE PROCEDURE VISUALIZAR_PCLIENTE_CONTRATO(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CLIENTE OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CLIENTE FOR
SELECT C.FOLIO_CONTRATO,C.MODIFICADO,C.ESTADO
FROM  CONTRATO C FULL JOIN TIPO_USUARIO T  ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                FULL JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE T.TIPO = 'Cliente' AND U.HABILITADO = 1 AND U.RUT_USUARIO = IN_USUARIO;
END;
/

-- VISUALIZAR FONDO MONETARIO Y DEUDA EN CONTRATO 
CREATE OR REPLACE PROCEDURE VISUALIZAR_FONDO_PCONTRATO(IN_USUARIO IN VARCHAR2,OUT_CURSOR_FONDO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_FONDO FOR
SELECT F.MONTO_ABONO, C.MONTO_PAGO 
FROM FONDO_MONETARIO F JOIN CONTRATO C ON F.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                       JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                       JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE U.RUT_USUARIO = IN_USUARIO AND C.ESTADO = 0;
END;
/

-- VISUALIZAR SOLO FONDO MONETARIO
CREATE OR REPLACE PROCEDURE VISUALIZAR_FONDO_PU(IN_USUARIO IN VARCHAR2,OUT_CURSOR_FONDO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_FONDO FOR
SELECT F.MONTO_ABONO 
FROM FONDO_MONETARIO F JOIN CONTRATO C ON F.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                       JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                       JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE U.RUT_USUARIO = IN_USUARIO;
END;
/


--BUSQUEDA DE ID DE SERVICIO X USUARIO CUANDO ES CONTRATO 
CREATE OR REPLACE PROCEDURE BUSCAR_SERVICIOC_XU(IN_USUARIO IN VARCHAR2,OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT S.ID_SERVICIO FROM SERVICIO S JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                         JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
WHERE T.RUT_USUARIO = IN_USUARIO AND S.NOMBRE_SERVICIO = 'Contrato';
END;
/

-- VISUALIZAR NOMBRE DE PROFESION DE PROFESIONAL X ID USUARIO 
CREATE OR REPLACE PROCEDURE BUSCAR_PROFESION_XU(IN_USUARIO IN VARCHAR2,OUT_CURSOR_PROFESIONAL OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_PROFESIONAL FOR
SELECT P.NOMBRE_PROFESION FROM TIPO_USUARIO T 
                          JOIN PROFESION P ON T.ID_TIPO_USUARIO = P.ID_TIPO_USUARIO
WHERE T.RUT_USUARIO = IN_USUARIO;
END;
/

-- VISUALIZAR DATOS DE PAGO X ID USUARIO 
CREATE OR REPLACE PROCEDURE BUSCAR_PAGOS_XU(IN_USUARIO IN VARCHAR2,OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_PAGO FOR
SELECT P.ID_PAGO,P.VALOR_TOTAL,P.DESCRIPCION, S.NOMBRE_SERVICIO, P.FECHA_PAGO,S.DESCRIPCION_SERVICIO,S.PAGADO
FROM PAGO P JOIN SERVICIO S ON P.ID_SERVICIO = S.ID_SERVICIO 
                     JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                     JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                     JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE U.RUT_USUARIO = IN_USUARIO;
END;
/

-- VISUALIZAR DATOS DE PAGO X ID DE PAGO 
CREATE OR REPLACE PROCEDURE BUSCAR_PAGOS_XID(IN_PAGO IN NUMBER,OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_PAGO FOR
SELECT VALOR_TOTAL,DESCRIPCION,FECHA_PAGO 
FROM PAGO
WHERE ID_PAGO = IN_PAGO;
END;
/

-- VISUALIZAR TODOS LOS PAGOS X ADMIN
CREATE OR REPLACE PROCEDURE BUSCAR_PAGOS_XAD(OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_PAGO FOR
SELECT P.ID_PAGO,P.VALOR_TOTAL,P.DESCRIPCION, S.NOMBRE_SERVICIO, P.FECHA_PAGO,S.DESCRIPCION_SERVICIO,S.PAGADO,S.ESTADO,T.RUT_USUARIO
FROM PAGO P JOIN SERVICIO S ON P.ID_SERVICIO = S.ID_SERVICIO 
                     JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                     JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                     JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO;
END;
/


-- VISUALIZAR TODOS LOS FONDOS X ADMIN
CREATE OR REPLACE PROCEDURE BUSCAR_FONDOS_XAD(OUT_CURSOR_FONDO OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_FONDO FOR
SELECT F.MONTO_ABONO,F.FOLIO_CONTRATO,F.FECHA_ABONO,T.RUT_USUARIO
FROM FONDO_MONETARIO F JOIN CONTRATO C ON F.FOLIO_CONTRATO = C.FOLIO_CONTRATO 
                       JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO;
END;
/


-- BUSCAR USUARIO PROFESIONAL 
CREATE OR REPLACE PROCEDURE BUSCAR_USUARIO_PROFE(IN_USUARIO IN VARCHAR2, OUT_CURSOR_USUARIO OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_USUARIO FOR
       SELECT U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.DOMICILIO_USUARIO,U.TELEFONO_USUARIO,U.CORREO_USUARIO,P.NOMBRE_PROFESION
            FROM USUARIO U JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO 
                           JOIN PROFESION P ON T.ID_TIPO_USUARIO = P.ID_TIPO_USUARIO
            WHERE U.RUT_USUARIO = IN_USUARIO;
    END;
/


-- BUSCAR VISITA X RUT Y FECHA 
CREATE OR REPLACE PROCEDURE BUSCAR_VISITA_XUF(IN_USUARIO IN VARCHAR2,IN_FECHA IN DATE,OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_VISITA FOR
         SELECT COUNT(A.ID_ACTIVIDAD) AS CONTADOR 
         FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
                             JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                             JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
                             JOIN TIPO_ACTIVIDAD T ON T.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE A.FECHA_INICIO = IN_FECHA AND TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Visita';
    END;
/


-- BUSCAR VISITA X RUT Y MES SELECCIONADO 
CREATE OR REPLACE PROCEDURE BUSCAR_VISITA_XUM(IN_USUARIO IN VARCHAR2,IN_FECHA IN DATE,OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_VISITA FOR
       SELECT COUNT(A.ID_ACTIVIDAD) AS CONTADOR 
         FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
                             JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                             JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
                             JOIN TIPO_ACTIVIDAD T ON T.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Visita'
        GROUP BY EXTRACT(MONTH FROM A.FECHA_INICIO) 
        HAVING EXTRACT(MONTH FROM A.FECHA_INICIO) = EXTRACT(MONTH FROM IN_FECHA);
    END;
/


-- BUSCAR DATOS DE VISITA CON RUT Y SERVICIO 
CREATE OR REPLACE PROCEDURE BUSCAR_VISITA(OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_VISITA FOR
    SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD, A.FECHA_INICIO,A.FECHA_TERMINO,A.ESTADO AS ESTADO_A, S.ESTADO AS ESTADO_S,S.PAGADO,T.RUT_USUARIO
    FROM ACTIVIDAD A LEFT JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
                                   JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                                   JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
    WHERE A.NOMBRE_ACTIVIDAD = 'Visita';
    END;
/


-- BUSCAR DATOS DE VISITA CON RUT Y SERVICIO X RUT DE USUARIO
CREATE OR REPLACE PROCEDURE BUSCAR_VISITA_XRUT(IN_USUARIO IN VARCHAR2,OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_VISITA FOR
     SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD, A.FECHA_INICIO,A.FECHA_TERMINO,A.ESTADO AS ESTADO_A, S.ESTADO AS ESTADO_S,S.PAGADO,T.RUT_USUARIO
    FROM ACTIVIDAD A LEFT JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
                                   JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                                   JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
    WHERE A.NOMBRE_ACTIVIDAD = 'Visita' AND T.RUT_USUARIO = IN_USUARIO;
    END;
/


-- BUSCAR DATOS DE VISITA CON RUT Y SERVICIO X ID DE ACTIVIDAD

CREATE OR REPLACE PROCEDURE BUSCAR_VISITA_XIDA(IN_IDE IN NUMBER,OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_VISITA FOR
          SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD, A.FECHA_INICIO,A.FECHA_TERMINO,A.ESTADO AS ESTADO_A, S.ESTADO AS ESTADO_S,S.PAGADO,T.RUT_USUARIO
    FROM ACTIVIDAD A LEFT JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
                                   JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                                   JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
    WHERE A.NOMBRE_ACTIVIDAD = 'Visita' AND A.ID_ACTIVIDAD = IN_IDE;
    END;
/


-- BUSCAR CANTIDAD DE VISITAS REPROGRAMADAS AL A헲 DE TIPO VISITA X ID USUARIO Y FECHA DE REPROGRAMACION

CREATE OR REPLACE PROCEDURE BUSCAR_RCVISITA_XA(IN_USUARIO IN VARCHAR2,IN_FECHA IN DATE,OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_VISITA FOR
        SELECT COUNT(A.ID_ACTIVIDAD) AS CONTADOR 
         FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
                             JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                             JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
                             JOIN TIPO_ACTIVIDAD T ON T.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Visita' AND S.ESTADO = 2
        GROUP BY EXTRACT(YEAR FROM A.FECHA_INICIO) 
        HAVING EXTRACT(YEAR FROM A.FECHA_INICIO) = EXTRACT(YEAR FROM IN_FECHA);
    END;
/


-- BUSCAR PAGO PENDIENTE X ID USUARIO

CREATE OR REPLACE PROCEDURE BUSCAR_PAGOP_XIDU(IN_USUARIO IN VARCHAR2,OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_PAGO FOR
        SELECT S.ID_SERVICIO, S.NOMBRE_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,S.FECHA_TERMINO,S.VALOR_SERVICIO 
        FROM SERVICIO S 
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
        WHERE S.PAGADO = 0 AND T.RUT_USUARIO = IN_USUARIO;
    END;
/


-- BUSCAR PAGO  X ID SERVICIO 
CREATE OR REPLACE PROCEDURE BUSCAR_PAGOP_XIDS(IN_SERVICIO IN NUMBER,OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_PAGO FOR
            SELECT S.ID_SERVICIO, S.NOMBRE_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,S.FECHA_TERMINO,S.VALOR_SERVICIO,T.RUT_USUARIO 
            FROM SERVICIO S 
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
            WHERE S.PAGADO = 0 AND S.ID_SERVICIO = IN_SERVICIO;
    END;
/

-- VER ASISTENCIAS
CREATE OR REPLACE PROCEDURE VISUALIZAR_ASISTENCIASA(OUT_CURSOR_ASISTENCIA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ASISTENCIA FOR
            SELECT A.DESCRIPCION_ASISTENCIA,A.ESTADO AS ESTADOAS,A.FECHA_EMISION,
                     AC.ESTADO AS ESTADOAC,AC.NOMBRE_ACTIVIDAD,AC.DESCRIPCION_ACTIVIDAD,
                     AC.FECHA_INICIO,AC.FECHA_TERMINO
            FROM ASISTENCIA A 
            JOIN TIPO_ACTIVIDAD T ON A.ID_TIPO_ACTIVIDAD = T.ID_TIPO_ACTIVIDAD
            JOIN ACTIVIDAD AC ON T.ID_ACTIVIDAD = AC.ID_ACTIVIDAD;
    END;
/

-- VER ARCHIVO X ID DE ACTIVIDAD -- VISITA
CREATE OR REPLACE PROCEDURE BUSCAR_ARCHIVO_XID(IN_ACTIVIDAD IN NUMBER,OUT_CURSOR_CHECKLIST OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_CHECKLIST FOR
          SELECT C.ARCHIVO FROM CHECKLIST C
            JOIN TIPO_ACTIVIDAD T ON C.ID_TIPO_ACTIVIDAD = T.ID_TIPO_ACTIVIDAD
            WHERE T.NOMBRE_TIPO_ACTIVIDAD = 'Visita' AND T.ID_ACTIVIDAD = IN_ACTIVIDAD;
    END;
/

-- VER ARCHIVO X ID DE ACTIVIDAD -- ACCIDENTE 
CREATE OR REPLACE PROCEDURE BUSCAR_ARCHIVOAC_XID(IN_ACTIVIDAD IN NUMBER,OUT_CURSOR_REPORTE OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_REPORTE FOR
         SELECT R.ARCHIVO FROM REPORTE R
             JOIN TIPO_ACTIVIDAD T ON R.ID_TIPO_ACTIVIDAD = T.ID_TIPO_ACTIVIDAD
            WHERE T.NOMBRE_TIPO_ACTIVIDAD = 'Accidente' AND T.ID_TIPO_ACTIVIDAD = IN_ACTIVIDAD;
    END;
/

-- VER ARCHIVO X ID DE ACTIVIDAD -- FISCALIZACION 
CREATE OR REPLACE PROCEDURE BUSCAR_ARCHIVOFI_XID(IN_ACTIVIDAD IN NUMBER,OUT_CURSOR_REPORTE OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_REPORTE FOR
          SELECT R.ARCHIVO FROM REPORTE R
             JOIN TIPO_ACTIVIDAD T ON R.ID_TIPO_ACTIVIDAD = T.ID_TIPO_ACTIVIDAD
            WHERE T.NOMBRE_TIPO_ACTIVIDAD = 'Fiscalizacion' AND T.ID_TIPO_ACTIVIDAD = IN_ACTIVIDAD;
    END;
/

-- VISUALIZAR INFO DE SERVICIOS X RUT
CREATE  OR REPLACE PROCEDURE VISUALIZAR_INFO_SERVICIO_R(IN_USUARIO IN VARCHAR2,OUT_CURSOR_SERVICIO OUT SYS_REFCURSOR)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
BEGIN
OPEN OUT_CURSOR_SERVICIO FOR
SELECT TU.RUT_USUARIO,S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,S.FECHA_TERMINO,S.ESTADO,S.PAGADO
FROM SERVICIO S JOIN CONTRATO C ON S.ID_SERVICIO = C.FOLIO_CONTRATO
                JOIN TIPO_USUARIO TU ON S.ID_SERVICIO = TU.ID_TIPO_USUARIO

WHERE C.FOLIO_CONTRATO = F_CON;
END;
/


-- VISUALIZAR HISTORICO DE PAGOS Y SERVICIOS - USUARIOS
CREATE  OR REPLACE PROCEDURE VISUALIZAR_HISTORICO_PAGO_SR(IN_USUARIO IN VARCHAR2,OUT_CURSOR_PAGO OUT SYS_REFCURSOR)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
BEGIN
OPEN OUT_CURSOR_PAGO FOR
SELECT S.ID_SERVICIO,S.FOLIO_CONTRATO,S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,
       S.FECHA_TERMINO,S.ESTADO,S.PAGADO,P.VALOR_TOTAL,P.FECHA_PAGO,P.ID_PAGO
FROM SERVICIO S JOIN PAGO P ON S.ID_SERVICIO = P.ID_SERVICIO		
				JOIN CONTRATO C ON S.ID_SERVICIO = C.FOLIO_CONTRATO
                JOIN TIPO_USUARIO TU ON S.ID_SERVICIO = TU.ID_TIPO_USUARIO

WHERE C.FOLIO_CONTRATO =F_CON; 
END;
/


-- VISUALIZAR ACTIVIDAD - RUT USUARIO
CREATE OR REPLACE PROCEDURE VISUALIZAR_ACTIVIDAD(OUT_CURSOR_ACTIVIDAD OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ACTIVIDAD FOR
SELECT U.RUT_USUARIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD,A.ESTADO,A.FECHA_INICIO,A.FECHA_TERMINO
FROM ACTIVIDAD A  JOIN SERVICIO S ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
				  JOIN CONTRATO C ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO;
END;
/

-- VISUALIZAR ACCIDENTES
CREATE OR REPLACE PROCEDURE VISUALIZAR_ACCIDENTES_UW(OUT_CURSOR_ALERTA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ALERTA FOR
SELECT AL.ID_ALERTA, AL.ID_TIPO_ACTIVIDAD,AL.NOMBRE_ALERTA,AL.DESCRIPCION_ALERTA,AL.ESTADO AS ESTADO_ALERTA,
       AL.FECHA_ALERTA, A.ESTADO AS ESTADO_ACTIVIDAD, S.ESTADO AS ESTADO_SERVICIO, TI.RUT_USUARIO
FROM ALERTA AL 
JOIN TIPO_ACTIVIDAD TA ON AL.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
WHERE AL.NOMBRE_ALERTA = 'Accidente';
END;
/

-- VISUALIZAR ACCIDENTES X USUARIO
CREATE OR REPLACE PROCEDURE VISUALIZAR_ACCIDENTES_XID(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ALERTA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ALERTA FOR
SELECT AL.ID_ALERTA, AL.ID_TIPO_ACTIVIDAD,AL.NOMBRE_ALERTA,AL.DESCRIPCION_ALERTA,AL.ESTADO AS ESTADO_ALERTA,
       AL.FECHA_ALERTA, A.ESTADO AS ESTADO_ACTIVIDAD, S.ESTADO AS ESTADO_SERVICIO, TI.RUT_USUARIO
FROM ALERTA AL 
JOIN TIPO_ACTIVIDAD TA ON AL.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
WHERE AL.NOMBRE_ALERTA = 'Accidente' AND TI.RUT_USUARIO = IN_USUARIO;
END;
/

-- VISUALIZAR FISCALIZACION
CREATE OR REPLACE PROCEDURE VISUALIZAR_FISCALIZACION_UW(OUT_CURSOR_ALERTA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ALERTA FOR
SELECT AL.ID_ALERTA, AL.ID_TIPO_ACTIVIDAD,AL.NOMBRE_ALERTA,AL.DESCRIPCION_ALERTA,AL.ESTADO AS ESTADO_ALERTA,
       AL.FECHA_ALERTA, A.ESTADO AS ESTADO_ACTIVIDAD, S.ESTADO AS ESTADO_SERVICIO, TI.RUT_USUARIO
FROM ALERTA AL 
JOIN TIPO_ACTIVIDAD TA ON AL.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
WHERE AL.NOMBRE_ALERTA = 'Fiscalizacion';
END;
/

-- VISUALIZAR FISCALIZACION X USUARIO
CREATE OR REPLACE PROCEDURE VISUALIZAR_FISCALIZACION_XID(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ALERTA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ALERTA FOR
SELECT AL.ID_ALERTA, AL.ID_TIPO_ACTIVIDAD,AL.NOMBRE_ALERTA,AL.DESCRIPCION_ALERTA,AL.ESTADO AS ESTADO_ALERTA,
       AL.FECHA_ALERTA, A.ESTADO AS ESTADO_ACTIVIDAD, S.ESTADO AS ESTADO_SERVICIO, TI.RUT_USUARIO
FROM ALERTA AL 
JOIN TIPO_ACTIVIDAD TA ON AL.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
WHERE AL.NOMBRE_ALERTA = 'Fiscalizacion' AND TI.RUT_USUARIO = IN_USUARIO;
END;
/


--VISUALIZAR DATOS DE ALERTA X ID 
CREATE OR REPLACE PROCEDURE VISUALIZAR_ALERTA_XID(IN_ID IN NUMBER,OUT_CURSOR_ALERTA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ALERTA FOR
SELECT  AL.ID_ALERTA, AL.ID_TIPO_ACTIVIDAD,A.ID_ACTIVIDAD,S.ID_SERVICIO,
        U.RUT_USUARIO,U.NOMBRE_USUARIO,U.CORREO_USUARIO,
        E.TELEFONO_EMPRESA,E.RAZON_SOCIAL_EMPRESA,E.DIRECCION_EMPRESA,
        A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD,A.FECHA_INICIO    
FROM ALERTA AL 
JOIN TIPO_ACTIVIDAD TA ON AL.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
JOIN EMPRESA E ON TI.RUT_USUARIO = E.RUT_USUARIO
JOIN USUARIO U ON E.RUT_EMPRESA = U.RUT_USUARIO
WHERE AL.ID_ALERTA = IN_ID;
END;
/


-- BUSCAR CANTIDAD DE ALERTAS POR A헲 X FECHA Y USUARIO

CREATE OR REPLACE PROCEDURE BUSCAR_ALERTAS_XA(IN_USUARIO IN VARCHAR2,IN_FECHA IN DATE,OUT_CURSOR_ALERTA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ALERTA FOR
        SELECT COUNT(*) AS CONTADOR
            FROM ALERTA AL 
            JOIN TIPO_ACTIVIDAD TA ON AL.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
            JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
            WHERE TI.RUT_USUARIO = IN_USUARIO
            GROUP BY EXTRACT(YEAR FROM AL.FECHA_ALERTA) 
            HAVING EXTRACT(YEAR FROM AL.FECHA_ALERTA) = EXTRACT(YEAR FROM IN_FECHA);
    END;
/


-- BUSCAR CANTIDAD DE ACTIVIDADES X DIA FECHA Y USUARIO 

CREATE OR REPLACE PROCEDURE BUSCAR_ACTIVIDADES_EMXFID(IN_USUARIO IN VARCHAR2,IN_FECHA IN DATE,OUT_CURSOR_ACTIVIDADES OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ACTIVIDADES FOR
        SELECT COUNT(*) AS CONTADOR
            FROM ACTIVIDAD A
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO 
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TI ON C.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO
            WHERE A.ESTADO < 3 AND TI.RUT_USUARIO = IN_USUARIO AND A.FECHA_INICIO = IN_FECHA
            AND A.NOMBRE_ACTIVIDAD IN('Visita','Accidente','Capacitacion','Fiscalizacion');
    END;
/


-- BUSCAR MEJORAS PARA PROFESIONALES
CREATE OR REPLACE PROCEDURE BUSCAR_MEJORAS_PROFES(OUT_CURSOR_MEJORA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_MEJORA FOR
        SELECT S.ID_SERVICIO, A.ID_ACTIVIDAD, M.ID_MEJORA,AP.ID_APROBACION, TI.RUT_USUARIO,
               M.DESCRIPCION_MEJORA,M.NOMBRE_MEJORA,M.ARCHIVO,M.FECHA_INICIO,
               M.ESTADO AS ESTADO_MEJORA, AP.ESTADO AS ESTADO_APROBACION,
               AP.FECHA_APROBACION
        FROM SERVICIO S 
        JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
        JOIN TIPO_ACTIVIDAD T ON A.ID_ACTIVIDAD = T.ID_ACTIVIDAD
        JOIN MEJORA M ON T.ID_TIPO_ACTIVIDAD = M.ID_TIPO_ACTIVIDAD
        JOIN APROBAR AP ON M.ID_MEJORA = AP.ID_MEJORA
        JOIN PROFESION P ON AP.ID_PROFESION = P.ID_PROFESION
        JOIN TIPO_USUARIO TI ON P.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO;
    END;
/

-- BUSCAR MEJORA X ID 
CREATE OR REPLACE PROCEDURE BUSCAR_MEJORAS_PROFXID(IN_MEJORA IN NUMBER,OUT_CURSOR_MEJORA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_MEJORA FOR
        SELECT S.ID_SERVICIO, A.ID_ACTIVIDAD, M.ID_MEJORA,AP.ID_APROBACION, TI.RUT_USUARIO,
       M.DESCRIPCION_MEJORA,M.NOMBRE_MEJORA,M.ARCHIVO,M.FECHA_INICIO    
        FROM USUARIO U 
        JOIN TIPO_USUARIO TI ON U.RUT_USUARIO = TI.RUT_USUARIO
        JOIN CONTRATO C ON TI.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
        JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
        JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
        JOIN TIPO_ACTIVIDAD T ON A.ID_ACTIVIDAD = T.ID_ACTIVIDAD
        JOIN MEJORA M ON T.ID_TIPO_ACTIVIDAD = M.ID_TIPO_ACTIVIDAD
        JOIN APROBAR AP ON M.ID_MEJORA = AP.ID_MEJORA
        WHERE M.ID_MEJORA = IN_MEJORA;
    END;
/

-- BUSCAR MEJORA PARA SEGUIMIENTO
CREATE OR REPLACE PROCEDURE BUSCAR_MEJORAS_ADMIN(OUT_CURSOR_MEJORA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_MEJORA FOR
        SELECT TI.RUT_USUARIO,M.ESTADO AS ESTADO_MEJORA, AP.ESTADO AS ESTADO_APROBACION,
             AP.FECHA_APROBACION,M.DESCRIPCION_MEJORA,M.NOMBRE_MEJORA,M.ARCHIVO,M.FECHA_INICIO
        FROM SERVICIO S 
        JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
        JOIN TIPO_ACTIVIDAD T ON A.ID_ACTIVIDAD = T.ID_ACTIVIDAD
        JOIN MEJORA M ON T.ID_TIPO_ACTIVIDAD = M.ID_TIPO_ACTIVIDAD
        JOIN APROBAR AP ON M.ID_MEJORA = AP.ID_MEJORA
        JOIN PROFESION P ON AP.ID_PROFESION = P.ID_PROFESION
        JOIN TIPO_USUARIO TI ON P.ID_TIPO_USUARIO = TI.ID_TIPO_USUARIO;
    END;
/


-- BUSCAR MEJORAS APROBADAS X RUT DE USUARIO
CREATE OR REPLACE PROCEDURE BUSCAR_MEJORAS_XRUT(IN_USUARIO IN VARCHAR2,OUT_CURSOR_MEJORA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_MEJORA FOR
           SELECT TI.RUT_USUARIO,M.ESTADO AS ESTADO_MEJORA, AP.ESTADO AS ESTADO_APROBACION,
             AP.FECHA_APROBACION,M.DESCRIPCION_MEJORA,M.NOMBRE_MEJORA,M.ARCHIVO,M.FECHA_INICIO
        FROM USUARIO U 
        JOIN TIPO_USUARIO TI ON U.RUT_USUARIO = TI.RUT_USUARIO
        JOIN CONTRATO C ON TI.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
        JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
        JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
        JOIN TIPO_ACTIVIDAD T ON A.ID_ACTIVIDAD = T.ID_ACTIVIDAD
        JOIN MEJORA M ON T.ID_TIPO_ACTIVIDAD = M.ID_TIPO_ACTIVIDAD
        JOIN APROBAR AP ON M.ID_MEJORA = AP.ID_MEJORA
        WHERE U.RUT_USUARIO = IN_USUARIO AND M.ESTADO = 2 AND AP.ESTADO = 2;
    END;
/


-- VISUALIZA DATOS GENERALES DE PROFESIONALES - ASISTENTES - ACTIVOS
CREATE OR REPLACE PROCEDURE VISUALIZAR_USUA_PROFES_ACT(OUT_CURSOR_PROFESIONAL OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_PROFESIONAL FOR
SELECT U.RUT_USUARIO,U.CORREO_USUARIO, U.NOMBRE_USUARIO,U.APELLIDO_USUARIO, 
       P.NOMBRE_PROFESION,U.DOMICILIO_USUARIO,U.TELEFONO_USUARIO,U.HABILITADO  
FROM USUARIO U 
JOIN TIPO_USUARIO T ON U.RUT_USUARIO = T.RUT_USUARIO
JOIN PROFESION P ON T.ID_TIPO_USUARIO = P.ID_TIPO_USUARIO
WHERE P.NOMBRE_PROFESION = 'Asistente' AND U.HABILITADO = 1;
END;
/


-- VISUALIZA DATOS GENERALES DE INTERACCIONES - ASISTENTES - XID -- ACTIVOS
CREATE OR REPLACE PROCEDURE VISUALIZAR_PROF_CHAT_XID(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CHAT OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CHAT FOR
SELECT TI.RUT_USUARIO,I.ID_PROFESIONAL,S.ID_SERVICIO,A.ID_ACTIVIDAD, U.NOMBRE_USUARIO,
       U.APELLIDO_USUARIO,U.CORREO_USUARIO,U.TELEFONO_USUARIO,A.ESTADO,I.FECHA_INTERACION
FROM USUARIO U JOIN TIPO_USUARIO TI ON U.RUT_USUARIO = TI.RUT_USUARIO
JOIN CONTRATO C ON TI.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
JOIN TIPO_ACTIVIDAD TA ON A.ID_ACTIVIDAD = TA.ID_ACTIVIDAD
JOIN INTERACCION I ON TA.ID_TIPO_ACTIVIDAD = I.ID_TIPO_ACTIVIDAD
WHERE A.ESTADO = 1 AND I.ID_PROFESIONAL = IN_USUARIO AND A.NOMBRE_ACTIVIDAD ='Chat';
END;
/

-- VISUALIZA DATOS GENERALES DE INTERACCIONES - ASISTENTES - XID
CREATE OR REPLACE PROCEDURE VISUALIZAR_PROF_CHAT(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CHAT OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CHAT FOR
SELECT TI.RUT_USUARIO,I.ID_PROFESIONAL,S.ID_SERVICIO,A.ID_ACTIVIDAD, U.NOMBRE_USUARIO,
       U.APELLIDO_USUARIO,U.CORREO_USUARIO,U.TELEFONO_USUARIO,A.ESTADO,I.FECHA_INTERACION
FROM USUARIO U JOIN TIPO_USUARIO TI ON U.RUT_USUARIO = TI.RUT_USUARIO
JOIN CONTRATO C ON TI.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
JOIN TIPO_ACTIVIDAD TA ON A.ID_ACTIVIDAD = TA.ID_ACTIVIDAD
JOIN INTERACCION I ON TA.ID_TIPO_ACTIVIDAD = I.ID_TIPO_ACTIVIDAD
WHERE I.ID_PROFESIONAL = IN_USUARIO AND A.NOMBRE_ACTIVIDAD ='Chat';
END;
/


-- VISUALIZAR DATOS GENERALES DE INTERACCIONES X ID DE ACTIVIDAD PARA PROFESIONAL
CREATE OR REPLACE PROCEDURE VISUALIZAR_CHAT_XIDAP(IN_ACTIVIDAD IN NUMBER,OUT_CURSOR_CHAT OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CHAT FOR
SELECT TI.RUT_USUARIO,I.ID_PROFESIONAL,S.ID_SERVICIO,A.ID_ACTIVIDAD, U.NOMBRE_USUARIO,
       U.APELLIDO_USUARIO,U.CORREO_USUARIO,U.TELEFONO_USUARIO,A.ESTADO,I.FECHA_INTERACION
FROM USUARIO U JOIN TIPO_USUARIO TI ON U.RUT_USUARIO = TI.RUT_USUARIO
JOIN CONTRATO C ON TI.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
JOIN TIPO_ACTIVIDAD TA ON A.ID_ACTIVIDAD = TA.ID_ACTIVIDAD
JOIN INTERACCION I ON TA.ID_TIPO_ACTIVIDAD = I.ID_TIPO_ACTIVIDAD
WHERE A.NOMBRE_ACTIVIDAD ='Chat' AND A.ID_ACTIVIDAD = IN_ACTIVIDAD;
END;
/

-- VISUALIZAR DATOS GENERALES DE INTERACCIONES X ID DE ACTIVIDAD PARA CLIENTE
CREATE OR REPLACE PROCEDURE VISUALIZAR_CHAT_XIDAC(IN_ACTIVIDAD IN NUMBER,OUT_CURSOR_CHAT OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CHAT FOR
SELECT TU.RUT_USUARIO,I.ID_PROFESIONAL,A.ID_ACTIVIDAD, S.ID_SERVICIO,U.NOMBRE_USUARIO,
       U.APELLIDO_USUARIO,U.CORREO_USUARIO,U.TELEFONO_USUARIO,A.ESTADO,I.FECHA_INTERACION
FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO 
JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO 
JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO 
JOIN TIPO_ACTIVIDAD TI ON A.ID_ACTIVIDAD = TI.ID_ACTIVIDAD
JOIN INTERACCION I ON TI.ID_TIPO_ACTIVIDAD = I.ID_TIPO_ACTIVIDAD
JOIN USUARIO U ON I.ID_PROFESIONAL = U.RUT_USUARIO
WHERE A.NOMBRE_ACTIVIDAD = 'Chat' AND A.ID_ACTIVIDAD = IN_ACTIVIDAD;
END;
/

-- VISUALIZAR DATOS GENERALES DE INTERACCIONES X ID DE CLIENTE
CREATE OR REPLACE PROCEDURE VISUALIZAR_USER_CHAT_XID(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CHAT OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CHAT FOR
SELECT TU.RUT_USUARIO,I.ID_PROFESIONAL,A.ID_ACTIVIDAD, S.ID_SERVICIO,U.NOMBRE_USUARIO,
       U.APELLIDO_USUARIO,U.CORREO_USUARIO,U.TELEFONO_USUARIO,A.ESTADO,I.FECHA_INTERACION
FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO 
JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO 
JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO 
JOIN TIPO_ACTIVIDAD TI ON A.ID_ACTIVIDAD = TI.ID_ACTIVIDAD
JOIN INTERACCION I ON TI.ID_TIPO_ACTIVIDAD = I.ID_TIPO_ACTIVIDAD
JOIN USUARIO U ON I.ID_PROFESIONAL = U.RUT_USUARIO
WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Chat';
END;
/

-- VISUALIZAR DATOS GENERALES DE INTERACCIONES PARA ADMIN
CREATE OR REPLACE PROCEDURE VISUALIZAR_ADMIN_CHAT_XID(OUT_CURSOR_CHAT OUT SYS_REFCURSOR)AS
BEGIN
 OPEN OUT_CURSOR_CHAT FOR
SELECT TU.RUT_USUARIO,I.ID_PROFESIONAL,A.ID_ACTIVIDAD, S.ID_SERVICIO,U.NOMBRE_USUARIO,
       U.APELLIDO_USUARIO,U.CORREO_USUARIO,U.TELEFONO_USUARIO,A.ESTADO,I.FECHA_INTERACION
FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO 
JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO 
JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO 
JOIN TIPO_ACTIVIDAD TI ON A.ID_ACTIVIDAD = TI.ID_ACTIVIDAD
JOIN INTERACCION I ON TI.ID_TIPO_ACTIVIDAD = I.ID_TIPO_ACTIVIDAD
JOIN USUARIO U ON I.ID_PROFESIONAL = U.RUT_USUARIO
WHERE A.NOMBRE_ACTIVIDAD = 'Chat';
END;
/

-- BUSCAR CANTIDAD DE CAPACITACIONES X A헲 Y MES DE VISITA X ID DE USUARIO

CREATE OR REPLACE PROCEDURE BUSCAR_CAPACIAID_XA(IN_USUARIO IN VARCHAR2,IN_FECHA IN DATE,OUT_CURSOR_CAPACI OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_CAPACI FOR
        SELECT COUNT(A.ID_ACTIVIDAD) AS CONTADOR 
         FROM TIPO_USUARIO TU JOIN CONTRATO C ON TU.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO
                             JOIN SERVICIO S ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                             JOIN ACTIVIDAD A ON S.ID_SERVICIO = A.ID_SERVICIO
                             JOIN TIPO_ACTIVIDAD T ON T.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Capacitacion' AND S.ESTADO = 1
        GROUP BY EXTRACT(YEAR FROM A.FECHA_INICIO), EXTRACT(MONTH FROM A.FECHA_INICIO)
        HAVING EXTRACT(YEAR FROM A.FECHA_INICIO) = EXTRACT(YEAR FROM IN_FECHA) 
        AND EXTRACT(MONTH FROM A.FECHA_INICIO) = EXTRACT(MONTH FROM IN_FECHA);
    END;
/


-- BUSCAR DATOS DE CAPACITACION CON RUT Y SERVICIO 
CREATE OR REPLACE PROCEDURE BUSCAR_CAPACITACION(OUT_CURSOR_CAPACITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_CAPACITA FOR
    SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD, A.FECHA_INICIO,A.FECHA_TERMINO,A.ESTADO AS ESTADO_A, S.ESTADO AS ESTADO_S,S.PAGADO,T.RUT_USUARIO
    FROM ACTIVIDAD A LEFT JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
                                   JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                                   JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
    WHERE A.NOMBRE_ACTIVIDAD = 'Capacitacion';
    END;
/


-- BUSCAR DATOS DE CAPACITACION CON RUT Y SERVICIO X RUT DE USUARIO
CREATE OR REPLACE PROCEDURE BUSCAR_CAPACITA_XRUT(IN_USUARIO IN VARCHAR2,OUT_CURSOR_CAPACITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_CAPACITA FOR
     SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD, A.FECHA_INICIO,A.FECHA_TERMINO,A.ESTADO AS ESTADO_A, S.ESTADO AS ESTADO_S,S.PAGADO,T.RUT_USUARIO
    FROM ACTIVIDAD A LEFT JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
                                   JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                                   JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
    WHERE A.NOMBRE_ACTIVIDAD = 'Capacitacion' AND T.RUT_USUARIO = IN_USUARIO;
    END;
/


-- BUSCAR DATOS DE CAPACITACION CON RUT Y SERVICIO X ID DE ACTIVIDAD

CREATE OR REPLACE PROCEDURE BUSCAR_CAPACITA_XIDA(IN_IDE IN NUMBER,OUT_CURSOR_CAPACITA OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_CAPACITA FOR
          SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD, A.FECHA_INICIO,A.FECHA_TERMINO,A.ESTADO AS ESTADO_A, S.ESTADO AS ESTADO_S,S.PAGADO,T.RUT_USUARIO
          FROM ACTIVIDAD A LEFT JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
                                   JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
                                   JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
         WHERE A.NOMBRE_ACTIVIDAD = 'Capacitacion' AND A.ID_ACTIVIDAD = IN_IDE;
    END;
/

-- VER ARCHIVO X ID DE ACTIVIDAD -- VISITA
CREATE OR REPLACE PROCEDURE BUSCAR_INFORMECA_XID(IN_ACTIVIDAD IN NUMBER,OUT_CURSOR_INFORME OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_INFORME FOR
          SELECT C.ARCHIVO FROM INFORME C
          JOIN TIPO_ACTIVIDAD T ON C.ID_TIPO_ACTIVIDAD = T.ID_TIPO_ACTIVIDAD
          WHERE T.NOMBRE_TIPO_ACTIVIDAD = 'Capacitacion' AND T.ID_ACTIVIDAD = IN_ACTIVIDAD;
    END;
/

-- VISUALIZAR ACTIVIDAD - RUT USUARIO -ID_ACTIBVIDAD
CREATE OR REPLACE PROCEDURE VISUALIZAR_ACTIVIDAD_ID(OUT_CURSOR_ACTIVIDAD OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ACTIVIDAD FOR
SELECT A.ID_ACTIVIDAD,U.RUT_USUARIO,A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD,A.ESTADO,A.FECHA_INICIO,A.FECHA_TERMINO
FROM ACTIVIDAD A  JOIN SERVICIO S ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
				  JOIN CONTRATO C ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U ON T.RUT_USUARIO = U.RUT_USUARIO;
END;
/

-- VISUALIZAR ESTADISTICA - RUT USUARIO
CREATE OR REPLACE PROCEDURE VISUALIZAR_ESTADISTICA(OUT_CURSOR_ESTADISTICA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ESTADISTICA FOR
SELECT U.RUT_USUARIO,R.NOMBRE_REPORTE,R.ARCHIVO,R.DESCRIPCION_REPORTE,R.FECHA_EMISION
FROM REPORTE R    JOIN TIPO_ACTIVIDAD TA ON R.ID_REPORTE = TA.ID_TIPO_ACTIVIDAD
                  JOIN ACTIVIDAD A       ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                  JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
				  JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO;			  
END;
/

-- VISUALIZAR VISITA 
CREATE OR REPLACE PROCEDURE VISUALIZAR_VISITA(OUT_CURSOR_VISITA OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_VISITA FOR
SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,S.ESTADO,U.RUT_USUARIO,A.NOMBRE_ACTIVIDAD,A.FECHA_INICIO,A.FECHA_TERMINO
FROM TIPO_ACTIVIDAD TA JOIN ACTIVIDAD A  ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                  JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
				  JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE TA.NOMBRE_TIPO_ACTIVIDAD = 'Visita';
END;
/

-- VISUALIZAR ESTADISTICA 
CREATE OR REPLACE PROCEDURE VISUALIZAR_CHECKLIST(OUT_CURSOR_CHECKLIST OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_CHECKLIST FOR
SELECT U.RUT_USUARIO,CH.ARCHIVO,CH.NOMBRE_CHECKLIST,CH.DESCRIPCION,CH.FECHA_EMISION
FROM CHECKLIST CH  JOIN TIPO_ACTIVIDAD TA ON CH.ID_CHECKLIST = TA.ID_TIPO_ACTIVIDAD
                  JOIN ACTIVIDAD A       ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                  JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
				  JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO;			  		  
END;
/


-- VISUALIZAR ACCIDENTE 
CREATE OR REPLACE PROCEDURE VISUALIZAR_ACC(OUT_CURSOR_ACC OUT SYS_REFCURSOR)AS
BEGIN
OPEN OUT_CURSOR_ACC FOR
SELECT A.ID_ACTIVIDAD,S.ID_SERVICIO,S.ESTADO,U.RUT_USUARIO,A.NOMBRE_ACTIVIDAD,A.FECHA_INICIO,A.FECHA_TERMINO
FROM TIPO_ACTIVIDAD TA JOIN ACTIVIDAD A  ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                  JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
				  JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE TA.NOMBRE_TIPO_ACTIVIDAD = 'Accidente';	  		  
END;
/

-------------------------------------------------------------------------------------------------------------------------------

---------------------------   ESTADISTICA DASHBOARD WEB  ----------------------------------------------------------------------

-------------------------------------------------------------------------------------------------------------------------------
-- ADMINISTRADOR
-- CANTIDAD TOTAL DE ACTIVIDADES X MES 
CREATE OR REPLACE PROCEDURE CANTIDAD_ACTIVIDAD_XM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(ID_ACTIVIDAD) AS "CONTADOR", TO_CHAR(FECHA_INICIO, 'Month') AS"NOMBRE_MES", EXTRACT(MONTH FROM FECHA_INICIO) 
        FROM ACTIVIDAD
        WHERE EXTRACT(YEAR FROM FECHA_INICIO) = EXTRACT(YEAR FROM SYSDATE)
        GROUP BY TO_CHAR(FECHA_INICIO, 'Month'), EXTRACT(MONTH FROM FECHA_INICIO)
        ORDER BY EXTRACT(MONTH FROM FECHA_INICIO);
    END;
/


-- TOTAL DE VISITAS 
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_VISITAS_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD = 'Visita';
    END;
/

-- TOTAL DE CAPACITACIONES
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_CAPACI_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD = 'Capacitacion';
    END;
/

-- TOTAL DE ALERTAS
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_ALERT_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD = 'Accidente' OR NOMBRE_ACTIVIDAD = 'Fiscalizacion';
    END;
/

-- TOTAL DE ASISTENCIAS
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_ASIS_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ASISTENCIA
        WHERE ESTADO = 1;
    END;
/

-- TOTAL DE USUARIOS ACTIVOS
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_USUA_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM USUARIO U 
        JOIN TIPO_USUARIO TU ON U.RUT_USUARIO = TU.RUT_USUARIO
        WHERE TU.TIPO = 'Cliente' AND U.HABILITADO = 1;
    END;
/

-- TOTAL DE CONTRATOS CREADOS X MES
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_CCREA_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
       SELECT COUNT(*) AS CONTADOR, TO_CHAR(FECHA_CONTRATO, 'Month') AS"NOMBRE_MES",
       EXTRACT(MONTH FROM FECHA_CONTRATO) AS NUM_MES
       FROM CONTRATO
       GROUP BY EXTRACT(MONTH FROM FECHA_CONTRATO), TO_CHAR(FECHA_CONTRATO, 'Month')
       ORDER BY EXTRACT(MONTH FROM FECHA_CONTRATO);
    END;
/


-- TOTAL DE PAGOS
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_PAGOS_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT SUM(VALOR_TOTAL) AS TOTAL_PAGO
        FROM PAGO;
    END;
/

-- PAGOS X MES 

CREATE OR REPLACE PROCEDURE ESTA_TOTAL_PXMES_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS PAGOS_R,TO_CHAR(FECHA_PAGO, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM FECHA_PAGO) AS NUM_MES 
        FROM PAGO
        GROUP BY EXTRACT(MONTH FROM FECHA_PAGO), TO_CHAR(FECHA_PAGO, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_PAGO);
    END;
/

-- TOTAL X MES ASISTENCIAS Y CHATS -- RENDIMIENTO LABORAL 
CREATE OR REPLACE PROCEDURE ESTA_RENDIM_LAB_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS RENDIMIENTO_CANT,TO_CHAR(FECHA_INICIO, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM FECHA_INICIO) AS NUM_MES FROM ASISTENCIA ASI 
        FULL JOIN TIPO_ACTIVIDAD TA ON ASI.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
        JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE TA.NOMBRE_TIPO_ACTIVIDAD NOT LIKE 'Mejora'
        GROUP BY EXTRACT(MONTH FROM FECHA_INICIO), TO_CHAR(FECHA_INICIO, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_INICIO);
    END;
/

-- TOTAL DE MEJORAS
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_MEJORS_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
         WHERE NOMBRE_ACTIVIDAD = 'Mejora';
    END;
/

-- TOTAL DE PROFESIONALES
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_PROF_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM PROFESION;
    END;
/

-- TOTAL DE INASISTENCIAS 
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_INAS_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM ASISTENCIA
         WHERE ESTADO = 2;
    END;
/


-- TOTAL DE ACTIVIDADES GENERADAS
CREATE OR REPLACE PROCEDURE ESTA_TOTAL_ACT_ADM(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD; 
    END;
/


--CLIENTE
-- TOTAL ACTIVIDAD X MES X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_ACTXM_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR,TO_CHAR(A.FECHA_INICIO, 'Month') AS"NOMBRE_MES",
                EXTRACT(MONTH FROM A.FECHA_INICIO) AS NUM_MES
        FROM ACTIVIDAD A 
        JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
        JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
        JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
        WHERE TU.RUT_USUARIO = IN_USUARIO
        GROUP BY EXTRACT(MONTH FROM A.FECHA_INICIO), TO_CHAR(A.FECHA_INICIO, 'Month')
        ORDER BY EXTRACT(MONTH FROM A.FECHA_INICIO);
    END;
/

-- TOTAL VISITAS X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_VISIT_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD A
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
            WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Visita';
    END;
/

-- TOTAL CAPACITACIONES X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_CAPACI_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD A
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
            WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD = 'Capacitacion';
    END;
/

-- TOTAL ALERTAS X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_ALERT_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR  FROM ACTIVIDAD A
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
            WHERE TU.RUT_USUARIO = IN_USUARIO AND A.NOMBRE_ACTIVIDAD IN ('Accidente','Fiscalizacion');
    END;
/

-- TOTAL ASISTENCIA A TERRENO X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_ASISTE_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR FROM ASISTENCIA ASI 
            FULL JOIN TIPO_ACTIVIDAD TA ON ASI.ID_TIPO_ACTIVIDAD = TA.ID_TIPO_ACTIVIDAD
            JOIN ACTIVIDAD A ON TA.ID_ACTIVIDAD = A.ID_ACTIVIDAD
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
            WHERE TU.RUT_USUARIO = IN_USUARIO AND ASI.ID_ASISTENCIA IS NOT NULL AND ASI.ESTADO = 1;
    END;
/

-- TOTAL DE PROFESIONALES ACTIVOS
CREATE OR REPLACE PROCEDURE ESTA_T_PROA_CLI(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM PROFESION PRO 
        JOIN TIPO_USUARIO TU ON PRO.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
        JOIN USUARIO U ON TU.RUT_USUARIO = U.RUT_USUARIO
        WHERE U.HABILITADO = 1;
    END;
/


-- ACTIVIDADES X MES RESUELTAS
CREATE OR REPLACE PROCEDURE ESTA_T_ACXMES_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
         SELECT COUNT(*) AS CONTADOR,TO_CHAR(A.FECHA_INICIO, 'Month') AS"NOMBRE_MES",
            EXTRACT(MONTH FROM A.FECHA_INICIO) AS NUM_MES FROM ACTIVIDAD A
            JOIN SERVICIO S ON A.ID_SERVICIO = S.ID_SERVICIO
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
            WHERE TU.RUT_USUARIO = IN_USUARIO AND A.ESTADO = 4
            GROUP BY EXTRACT(MONTH FROM A.FECHA_INICIO), TO_CHAR(A.FECHA_INICIO, 'Month')
            ORDER BY EXTRACT(MONTH FROM A.FECHA_INICIO);
    END;
/


-- PAGOS X MES X RUT
CREATE OR REPLACE PROCEDURE ESTA_P_XMES_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS PAGOS_R,TO_CHAR(P.FECHA_PAGO, 'Month') AS"NOMBRE_MES",
                EXTRACT(MONTH FROM P.FECHA_PAGO) AS NUM_MES
            FROM PAGO P 
            JOIN SERVICIO S ON P.ID_SERVICIO = S.ID_SERVICIO
            JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
            JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
            WHERE TU.RUT_USUARIO = IN_USUARIO
            GROUP BY EXTRACT(MONTH FROM P.FECHA_PAGO), TO_CHAR(P.FECHA_PAGO, 'Month')
            ORDER BY EXTRACT(MONTH FROM P.FECHA_PAGO);
    END;
/


-- TOTAL FONDOS X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_FONDOS_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
       SELECT SUM(F.MONTO_ABONO) AS MONTO FROM FONDO_MONETARIO F 
        JOIN CONTRATO C ON F.FOLIO_CONTRATO = C.FOLIO_CONTRATO
        JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
        WHERE TU.RUT_USUARIO = IN_USUARIO;
    END;
/

-- TOTAL PAGADO X RUT
CREATE OR REPLACE PROCEDURE ESTA_T_PAGADO_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
       SELECT SUM(P.VALOR_TOTAL) AS MONTO FROM PAGO P 
        JOIN SERVICIO S ON P.ID_SERVICIO = S.ID_SERVICIO
        JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
        JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
        WHERE TU.RUT_USUARIO = IN_USUARIO; 
    END;
/

-- TOTAL A PAGAR X RUT --> DEBE
CREATE OR REPLACE PROCEDURE ESTA_T_DEBE_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
       SELECT COUNT(*) AS CONTADOR FROM SERVICIO S 
        JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
        JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
        WHERE TU.RUT_USUARIO = IN_USUARIO AND S.PAGADO = 2;
    END;
/

-- CANTIDAD PAGADA X RUT -- PAGOS REALIZADOS
CREATE OR REPLACE PROCEDURE ESTA_T_CPAGADA_CLI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
       SELECT COUNT(*) AS CONTADOR FROM PAGO P 
        JOIN SERVICIO S ON P.ID_SERVICIO = S.ID_SERVICIO
        JOIN CONTRATO C ON S.FOLIO_CONTRATO = C.FOLIO_CONTRATO
        JOIN TIPO_USUARIO TU ON C.ID_TIPO_USUARIO = TU.ID_TIPO_USUARIO
        WHERE TU.RUT_USUARIO = IN_USUARIO;
    END;
/

-- SUPERVISOR 

-- TOTAL DE VISITAS Y ACCIDENTES X MES
CREATE OR REPLACE PROCEDURE ESTA_TACTI_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR,TO_CHAR(FECHA_INICIO, 'Month') AS"NOMBRE_MES",
               EXTRACT(MONTH FROM FECHA_INICIO) AS NUM_MES FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD IN('Visita','Accidente','Fiscalizacion')
        GROUP BY EXTRACT(MONTH FROM FECHA_INICIO), TO_CHAR(FECHA_INICIO, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_INICIO);
    END;
/

-- TOTAL DE VISITAS
CREATE OR REPLACE PROCEDURE ESTA_TVISI_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD = 'Visita';
    END;
/

-- TOTAL DE ACCIDENTES 
CREATE OR REPLACE PROCEDURE ESTA_TACCI_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD IN ('Accidente');
    END;
/

-- TOTAL DE FISCALIZACIONES
CREATE OR REPLACE PROCEDURE ESTA_TFIS_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD IN ('Fiscalizacion');
    END;
/

-- TOTAL DE MEJORAS PROPUESTAS
CREATE OR REPLACE PROCEDURE ESTA_TMEJO_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM MEJORA;
    END;
/

-- TOTAL DE ASISTENCIA X MES - VISITA-ACCIDENTE-FISCALIZACION
CREATE OR REPLACE PROCEDURE ESTA_TASIS_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR,TO_CHAR(A.FECHA_INICIO, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM A.FECHA_INICIO) AS NUM_MES FROM ASISTENCIA ASI 
        JOIN TIPO_ACTIVIDAD TI ON ASI.ID_TIPO_ACTIVIDAD = TI.ID_TIPO_ACTIVIDAD
        JOIN ACTIVIDAD A ON TI.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE A.NOMBRE_ACTIVIDAD IN ('Visita','Fiscalizacion','Accidente') AND ASI.ESTADO = 1
        GROUP BY EXTRACT(MONTH FROM A.FECHA_INICIO), TO_CHAR(A.FECHA_INICIO, 'Month')
        ORDER BY EXTRACT(MONTH FROM A.FECHA_INICIO);
    END;
/

-- CANTIDAD DE ASISTENCIA - VISITA-ACCIDENTE-FISCALIZACION
CREATE OR REPLACE PROCEDURE ESTA_CASIS_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ASISTENCIA ASI
        JOIN TIPO_ACTIVIDAD TI ON ASI.ID_TIPO_ACTIVIDAD = TI.ID_TIPO_ACTIVIDAD
        JOIN ACTIVIDAD A ON TI.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE A.NOMBRE_ACTIVIDAD IN ('Visita','Fiscalizacion','Accidente')
        AND ASI.ESTADO = 1;
    END;
/

-- TOTAL DE USUARIOS ACTIVOS
CREATE OR REPLACE PROCEDURE ESTA_TUSER_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM USUARIO U 
        JOIN TIPO_USUARIO TU ON U.RUT_USUARIO = TU.RUT_USUARIO
        WHERE TU.TIPO = 'Cliente' AND U.HABILITADO = 1;
    END;
/

-- TOTAL DE CONTRATOS CREADOS X MES
CREATE OR REPLACE PROCEDURE ESTA_CCONT_SUPE(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR, TO_CHAR(FECHA_CONTRATO, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM FECHA_CONTRATO) AS NUM_MES
        FROM CONTRATO
        GROUP BY EXTRACT(MONTH FROM FECHA_CONTRATO), TO_CHAR(FECHA_CONTRATO, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_CONTRATO);
    END;
/

-- CAPACITADOR

-- TOTAL DE CAPACITACIONES X MES 
CREATE OR REPLACE PROCEDURE ESTA_T_CAPXM_CAP(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR,TO_CHAR(FECHA_INICIO, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM FECHA_INICIO) AS NUM_MES FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD IN('Capacitacion')
        GROUP BY EXTRACT(MONTH FROM FECHA_INICIO), TO_CHAR(FECHA_INICIO, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_INICIO);
    END;
/ 

-- TOTAL DE CAPACITACIONES 
CREATE OR REPLACE PROCEDURE ESTA_T_CAPAC_CAP(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD IN('Capacitacion');
    END;
/ 

-- TOTAL DE CAPACITACIONES FINALIZADAS
CREATE OR REPLACE PROCEDURE ESTA_T_CAPACF_CAP(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ACTIVIDAD
        WHERE NOMBRE_ACTIVIDAD IN('Capacitacion') AND ESTADO = 4;
    END;
/

-- TOTAL DE ASISTENCIA X MES - CAPACITACION
CREATE OR REPLACE PROCEDURE ESTA_T_ASIXM_CAP(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR,TO_CHAR(A.FECHA_INICIO, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM A.FECHA_INICIO) AS NUM_MES FROM ASISTENCIA ASI 
        JOIN TIPO_ACTIVIDAD TI ON ASI.ID_TIPO_ACTIVIDAD = TI.ID_TIPO_ACTIVIDAD
        JOIN ACTIVIDAD A ON TI.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE A.NOMBRE_ACTIVIDAD IN ('Capacitacion') AND ASI.ESTADO = 1
        GROUP BY EXTRACT(MONTH FROM A.FECHA_INICIO), TO_CHAR(A.FECHA_INICIO, 'Month')
        ORDER BY EXTRACT(MONTH FROM A.FECHA_INICIO);
    END;
/

-- CAPACITACIONES CREADAS
CREATE OR REPLACE PROCEDURE ESTA_T_CAPAR_CAP(OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM ASISTENCIA ASI 
        JOIN TIPO_ACTIVIDAD TI ON ASI.ID_TIPO_ACTIVIDAD = TI.ID_TIPO_ACTIVIDAD
        JOIN ACTIVIDAD A ON TI.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE A.NOMBRE_ACTIVIDAD IN ('Capacitacion') AND ASI.ESTADO = 1;
    END;
/

-- ASISTENTE
-- TOTAL DE INTERACCIONES X MES X USUARIO 
CREATE OR REPLACE PROCEDURE ESTA_T_INTERAXM_ASI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR, TO_CHAR(FECHA_INTERACION, 'Month') AS"NOMBRE_MES",
        EXTRACT(MONTH FROM FECHA_INTERACION) AS NUM_MES FROM INTERACCION
        WHERE ID_PROFESIONAL = IN_USUARIO
        GROUP BY EXTRACT(MONTH FROM FECHA_INTERACION), TO_CHAR(FECHA_INTERACION, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_INTERACION);
    END;
/

-- TOTAL DE INTERACCIONES X USUARIO
CREATE OR REPLACE PROCEDURE ESTA_T_INTERA_ASI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM INTERACCION
        WHERE ID_PROFESIONAL = IN_USUARIO
        GROUP BY EXTRACT(MONTH FROM FECHA_INTERACION), TO_CHAR(FECHA_INTERACION, 'Month')
        ORDER BY EXTRACT(MONTH FROM FECHA_INTERACION);
    END;
/


-- TOTAL DE APROBADAS X USUARIO
CREATE OR REPLACE PROCEDURE ESTA_T_APROBA_ASI(IN_USUARIO IN VARCHAR2,OUT_CURSOR_ESTADIS OUT SYS_REFCURSOR)AS
    BEGIN
        OPEN OUT_CURSOR_ESTADIS FOR
        SELECT COUNT(*) AS CONTADOR FROM INTERACCION I 
        JOIN TIPO_ACTIVIDAD TI ON I.ID_TIPO_ACTIVIDAD = TI.ID_TIPO_ACTIVIDAD
        JOIN ACTIVIDAD A ON TI.ID_ACTIVIDAD = A.ID_ACTIVIDAD
        WHERE I.ID_PROFESIONAL = IN_USUARIO AND A.ESTADO = 4;
    END;
/


-------------------------------------------------------------------------------------------------------------------------------

---------------------------   VERSION WEB  ------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------------------------------------

-- PERMITE CAMBIAR CONTRASE헤 
CREATE OR REPLACE PROCEDURE CAMBIAR_CONTRASE헤_W(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2,OUT_RESULTADO OUT VARCHAR2)AS
    U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
    BEGIN
        UPDATE LOGIN SET CONTRASE헤_USUARIO = APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤)
        WHERE ID_TIPO_USUARIO = U_IDT;
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE LA CREACION DE USUARIO DE MANERA GENERAL (USADO PARA ADMINISTRADORES)
CREATE OR REPLACE PROCEDURE CREAR_USUARIO_W(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, IN_TIPO IN VARCHAR2, IN_NOMBRE_USUARIO IN VARCHAR2,
                                                        IN_APELLIDO_USUARIO IN VARCHAR2, IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                        IN_DOMICILIO_USUARIO IN VARCHAR2,OUT_RESULTADO OUT VARCHAR2) AS
    T_ID NUMBER := ID_TIPO_USUARIO_I.NEXTVAL;
    L_ID NUMBER := ID_LOGIN_I.NEXTVAL;
    BEGIN
        INSERT INTO USUARIO VALUES(IN_USUARIO,IN_NOMBRE_USUARIO,IN_APELLIDO_USUARIO,IN_TELEFONO_USUARIO,IN_CORREO_USUARIO,IN_DOMICILIO_USUARIO,1);
        INSERT INTO TIPO_USUARIO VALUES(T_ID,IN_USUARIO,IN_TIPO);
        INSERT INTO LOGIN VALUES(L_ID,APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤),T_ID);
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE LA CREACION DE USUARIOS PROFESIONALES
CREATE OR REPLACE PROCEDURE CREAR_USUARIO_PROFESIONAL_W(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, IN_TIPO IN VARCHAR2, IN_NOMBRE_USUARIO IN VARCHAR2,
                                                        IN_APELLIDO_USUARIO IN VARCHAR2, IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                        IN_DOMICILIO_USUARIO IN VARCHAR2, IN_PROFESION IN VARCHAR2,OUT_RESULTADO OUT VARCHAR2) AS
    T_ID NUMBER := ID_TIPO_USUARIO_I.NEXTVAL;
    L_ID NUMBER := ID_LOGIN_I.NEXTVAL;
    P_ID NUMBER := ID_TIPO_PROFESIONAL_I.NEXTVAL;
    BEGIN
        INSERT INTO USUARIO VALUES(IN_USUARIO,IN_NOMBRE_USUARIO,IN_APELLIDO_USUARIO,IN_TELEFONO_USUARIO,IN_CORREO_USUARIO,IN_DOMICILIO_USUARIO,1);
        INSERT INTO TIPO_USUARIO VALUES(T_ID,IN_USUARIO,IN_TIPO);
        INSERT INTO LOGIN VALUES(L_ID,APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤),T_ID);
        INSERT INTO PROFESION VALUES(P_ID,T_ID,IN_PROFESION);
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE LA CREACION DE USUARIOS CLIENTES
CREATE OR REPLACE PROCEDURE CREAR_USUARIO_CLIENTE_W(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, IN_TIPO IN VARCHAR2, IN_NOMBRE_USUARIO IN VARCHAR2,
                                                  IN_APELLIDO_USUARIO IN VARCHAR2, IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                  IN_DOMICILIO_USUARIO IN VARCHAR2,
                                                  IN_RUT_EMPRESA IN VARCHAR2,IN_RAZON_SOCIAL IN VARCHAR2,
                                                  IN_DIRECCION IN VARCHAR2, IN_FONO IN NUMBER,IN_CORREO IN VARCHAR2,
                                                  IN_PAGINA_WEB IN VARCHAR2,OUT_RESULTADO OUT VARCHAR2) AS
    T_ID NUMBER := ID_TIPO_USUARIO_I.NEXTVAL;
    L_ID NUMBER := ID_LOGIN_I.NEXTVAL;
    BEGIN
        INSERT INTO USUARIO VALUES(IN_USUARIO,IN_NOMBRE_USUARIO,IN_APELLIDO_USUARIO,IN_TELEFONO_USUARIO,IN_CORREO_USUARIO,IN_DOMICILIO_USUARIO,1);
        INSERT INTO TIPO_USUARIO VALUES(T_ID,IN_USUARIO,IN_TIPO);
        INSERT INTO LOGIN VALUES(L_ID,APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤),T_ID);
        INSERT INTO EMPRESA VALUES(IN_RUT_EMPRESA,T_ID,IN_USUARIO,IN_RAZON_SOCIAL,IN_DIRECCION,IN_FONO,IN_CORREO,IN_PAGINA_WEB);
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE MODIFICAR DATOS DE EMPRESA DE USUARIO CLIENTE
CREATE OR REPLACE PROCEDURE MODIFICAR_USUARIO_CLIENTE_E_W(IN_USUARIO VARCHAR2, IN_R_SOCIAL IN VARCHAR2,IN_DIRECCION IN VARCHAR2,
                                                        IN_TELEFONO IN NUMBER, IN_CORREO IN VARCHAR2, 
                                                        IN_PAGINA_WEB IN VARCHAR2,OUT_RESULTADO OUT VARCHAR2)AS
 BEGIN     
        UPDATE EMPRESA SET RAZON_SOCIAL_EMPRESA = IN_R_SOCIAL 
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET DIRECCION_EMPRESA = IN_DIRECCION
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET TELEFONO_EMPRESA = IN_TELEFONO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET CORREO_EMPRESA = IN_CORREO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET PAGINA_WEB_EMPRESA = IN_PAGINA_WEB
        WHERE RUT_USUARIO = IN_USUARIO;
        
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE MODIFICAR DATOS DE USUARIOS
CREATE OR REPLACE PROCEDURE MODIFICAR_USUARIO_W(IN_USUARIO VARCHAR2, IN_NOMBRE IN VARCHAR2,IN_APELLIDO IN VARCHAR2,
                                                        IN_TELEFONO IN NUMBER, IN_CORREO IN VARCHAR2, 
                                                        IN_DOMICILIO IN VARCHAR2, OUT_RESULTADO OUT VARCHAR2)AS
 BEGIN     
        UPDATE USUARIO SET NOMBRE_USUARIO = IN_NOMBRE 
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET APELLIDO_USUARIO = IN_APELLIDO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET TELEFONO_USUARIO = IN_TELEFONO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET CORREO_USUARIO = IN_CORREO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET DOMICILIO_USUARIO = IN_DOMICILIO
        WHERE RUT_USUARIO = IN_USUARIO;
        
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE CAMBIAR EL ESTADO DE UN USUARIO 
CREATE OR REPLACE PROCEDURE MODIFICAR_ESTADO_USUARIO_W(IN_USUARIO IN VARCHAR2, IN_HABILITADO IN NUMBER, OUT_RESULTADO OUT VARCHAR2)AS
 BEGIN     
        UPDATE USUARIO SET HABILITADO = IN_HABILITADO
        WHERE RUT_USUARIO = IN_USUARIO;
        
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
    END;
/

-- PERMITE CAMBIAR LA PROFESION DE UN USUARIO 
CREATE OR REPLACE PROCEDURE MODIFICAR_PROFESION_USUARIO_W(IN_USUARIO IN VARCHAR2, IN_PROFESION IN VARCHAR2, OUT_RESULTADO OUT VARCHAR2) AS
 U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
BEGIN
        UPDATE PROFESION SET NOMBRE_PROFESION = IN_PROFESION
        WHERE ID_TIPO_USUARIO = U_IDT;
         COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
END;
/


-- PROCEDIMIENTOS CONTRATOS Y SERVICIOS DE PAGO 

-- CREACION DE CONTRATO 
CREATE OR REPLACE PROCEDURE CREAR_CONTRATO_W(IN_USUARIO IN VARCHAR2,IN_FECHAC IN DATE,IN_PLAZO IN VARCHAR2,IN_VALOR IN NUMBER,OUT_RESULTADO OUT VARCHAR2) AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := ID_FOLIO_CONTRATO.NEXTVAL;
BEGIN 
    --ESTADO 0 : NO PAGADO 
    --       1 : ACTIVO
    --       2 : DESHABILITADO
    
    --MODIFICADO 0 : NO MODIFICADO
    --           1 : MODIFICADO
    INSERT INTO CONTRATO VALUES(F_CON,U_IDT,IN_FECHAC,IN_PLAZO,IN_VALOR,0,0);
      COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/

-- CREACION DE SERVICIO DE TIPO CONTRATO
CREATE OR REPLACE PROCEDURE CREAR_SERVICIO_CONTRATO_W(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2,IN_FECHAI IN DATE, IN_FECHAT IN DATE, OUT_RESULTADO OUT VARCHAR2)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;

BEGIN 
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : EDITADA
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,0);
       COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/

-- CREACION DE ACTIVIDAD,TIPO ACTIVIDAD,SERVICIO 
CREATE OR REPLACE PROCEDURE CREAR_ACTIVIDAD_COMPLETA_W(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2,IN_NOMA IN VARCHAR2, IN_DESCRA IN VARCHAR2,IN_DESCP IN VARCHAR2,
                                                    IN_FECHAI IN DATE, IN_FECHAT IN DATE, OUT_RESULTADO OUT VARCHAR2)AS

U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;
I_ACT NUMBER := ID_ACTIVIDAD.NEXTVAL;
I_TAC NUMBER := ID_TIPO_ACTIVIDAD.NEXTVAL;
I_PAG NUMBER := ID_PAGO.NEXTVAL;
                                                    
BEGIN 
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : REPROGRAMADO
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,1);
    
    --ESTADO 1: CREADA
    --       2: EN PROGRESO  
    --       3: S/INFORME
    --       4: TERMINADA
    --       5: CANCELADA
    INSERT INTO ACTIVIDAD VALUES(I_ACT,I_SER,IN_NOMA,IN_DESCRA,1,IN_FECHAI,IN_FECHAT);
    INSERT INTO TIPO_ACTIVIDAD VALUES(I_TAC,I_ACT,IN_NOMA);
    INSERT INTO PAGO VALUES(I_PAG,I_SER,IN_VALORS,IN_DESCP,IN_FECHAI);
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/


-- CREACION DE FONDO MONETARIO 
CREATE OR REPLACE PROCEDURE CREAR_FONDO_MONETARIO_W(IN_USUARIO IN VARCHAR2,IN_MONTO IN NUMBER, IN_FECHA_ABONO IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
ID_FONDO NUMBER := ID_FONDO_MONETARIO.NEXTVAL;

BEGIN
    INSERT INTO FONDO_MONETARIO VALUES(ID_FONDO,F_CON,IN_MONTO,IN_FECHA_ABONO);
      COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/

-- CREACION DE PAGO SERVICIO CONTRATO
CREATE OR REPLACE PROCEDURE CREAR_PAGO_SERVICIO_W(IN_USUARIO IN VARCHAR2,IN_IDSERVICIO IN NUMBER,IN_DESCRIPCION IN VARCHAR2,IN_VALOR IN NUMBER,IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_PAGO NUMBER := ID_PAGO.NEXTVAL;

BEGIN 
    INSERT INTO PAGO VALUES(I_PAGO,IN_IDSERVICIO,IN_VALOR,IN_DESCRIPCION,IN_FECHA);
      COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/

-- EDITAR CONTRATO 
CREATE OR REPLACE PROCEDURE EDITAR_ESTADO_CONTRATO_W(IN_FOLIO_CONTRATO IN NUMBER,IN_MODIFICADO IN NUMBER,IN_ESTADO IN NUMBER,OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE CONTRATO SET MODIFICADO = IN_MODIFICADO
    WHERE FOLIO_CONTRATO = IN_FOLIO_CONTRATO; 
    UPDATE CONTRATO SET ESTADO = IN_ESTADO
    WHERE FOLIO_CONTRATO = IN_FOLIO_CONTRATO; 
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/

-- EDITAR ESTADO CONTRATO X USUARIO
CREATE OR REPLACE PROCEDURE EDITAR_ESTADO_CONTRATOU_W(IN_USUARIO IN VARCHAR2,IN_MODIFICADO IN NUMBER,IN_ESTADO IN NUMBER,OUT_RESULTADO OUT VARCHAR2)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);

BEGIN
    UPDATE CONTRATO SET MODIFICADO = IN_MODIFICADO
    WHERE FOLIO_CONTRATO = F_CON; 
    UPDATE CONTRATO SET ESTADO = IN_ESTADO
    WHERE FOLIO_CONTRATO = F_CON; 
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- EDITAR SERVICIO
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIO_W(IN_ID_SERVICIO IN NUMBER,IN_FECHAT IN DATE, IN_ESTADO IN NUMBER,IN_PAGADO IN NUMBER,OUT_RESULTADO OUT VARCHAR2)AS
BEGIN 
    UPDATE SERVICIO SET FECHA_TERMINO = IN_FECHAT
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    
    UPDATE SERVICIO SET ESTADO = IN_ESTADO
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    
    UPDATE SERVICIO SET PAGADO = IN_PAGADO
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/

-- EDITAR SERVICIO CONTRATO 
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIOC_W(IN_USUARIO IN VARCHAR2,IN_FECHAT IN DATE, IN_ESTADO IN NUMBER,IN_PAGADO IN NUMBER,OUT_RESULTADO OUT VARCHAR2)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);

BEGIN 
    UPDATE SERVICIO SET FECHA_TERMINO = IN_FECHAT
    WHERE NOMBRE_SERVICIO = 'Contrato' AND FOLIO_CONTRATO = F_CON;
    
    UPDATE SERVICIO SET ESTADO = IN_ESTADO
    WHERE NOMBRE_SERVICIO = 'Contrato' AND FOLIO_CONTRATO = F_CON;
    
    UPDATE SERVICIO SET PAGADO = IN_PAGADO
    WHERE NOMBRE_SERVICIO = 'Contrato' AND FOLIO_CONTRATO = F_CON;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- EDITAR FONDO_MONETARIO 

CREATE OR REPLACE PROCEDURE EDITAR_FONDO_MONETARIO_W(IN_USUARIO IN VARCHAR2,IN_MONTO IN NUMBER,IN_FECHA IN DATE, OUT_RESULTADO OUT VARCHAR2)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);

BEGIN 
    UPDATE FONDO_MONETARIO SET MONTO_ABONO = IN_MONTO
    WHERE FOLIO_CONTRATO = F_CON;
    
    UPDATE FONDO_MONETARIO SET FECHA_ABONO = IN_FECHA
    WHERE FOLIO_CONTRATO = F_CON;

   COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/

-- CANCELAR VISITA -- EDITAR ACTIVIDAD

CREATE OR REPLACE PROCEDURE EDITAR_CANCELAR_VISITA_W(IN_ACTIVIDAD IN NUMBER, IN_IDA IN NUMBER,IN_SERVICIO IN NUMBER, IN_IDS IN NUMBER, OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE SERVICIO SET ESTADO = IN_SERVICIO
    WHERE ID_SERVICIO = IN_IDS;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CREAR PAGO - SERVICIO COBRO EXTRA

CREATE OR REPLACE PROCEDURE CREAR_SERVICIO_PEX_W(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2, IN_FECHAI IN DATE, IN_FECHAT IN DATE,
                                                    OUT_RESULTADO OUT VARCHAR2)AS

U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;
                                                   
BEGIN 
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : REPROGRAMADO
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,0);
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/


-- EDITAR VISITA FECHA X ID 

CREATE OR REPLACE PROCEDURE EDITAR_FECHA_VISITA_W(IN_IDA IN NUMBER,IN_IDS IN NUMBER, IN_ESTADOS IN NUMBER,IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
BEGIN

    UPDATE ACTIVIDAD SET FECHA_INICIO = IN_FECHA
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE ACTIVIDAD SET FECHA_TERMINO = IN_FECHA
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE SERVICIO SET ESTADO = IN_ESTADOS 
    WHERE ID_SERVICIO = IN_IDS;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CREA ASISTENCIA PARA ACTIVIDAD VISITA
CREATE OR REPLACE PROCEDURE CREAR_ASISTENCIA_AID_W(IN_ACTIVIDAD IN NUMBER, IN_DESCA IN VARCHAR2, 
                                                    IN_ESTADO IN NUMBER,IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS

U_IDTA NUMBER := APP_USUARIO_SEGURIDAD.GET_TACTIVIDAD(IN_ACTIVIDAD);
I_ASIS NUMBER := ID_ASISTENCIA.NEXTVAL;
                                                   
BEGIN 
    --ESTADO 1 : ASISTENTE
    --       2 : INASISTENTE 
    INSERT INTO ASISTENCIA VALUES(I_ASIS,U_IDTA,IN_DESCA,IN_ESTADO,IN_FECHA);
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/

-- CAMBIAR ESTADO ACTIVIDAD - VISITA
CREATE OR REPLACE PROCEDURE EDITAR_ESTADO_ACTIVID_W(IN_ACTIVIDAD IN NUMBER, IN_IDA IN NUMBER, OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CREACION DE PAGO UNIVERSAL DEUDA PENDIENTE 
CREATE OR REPLACE PROCEDURE CREAR_PAGO_W(IN_USUARIO IN VARCHAR2,IN_IDSERVICIO IN NUMBER,IN_DESCRIPCION IN VARCHAR2,IN_VALOR IN NUMBER,IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
I_PAGO NUMBER := ID_PAGO.NEXTVAL;

BEGIN 
    INSERT INTO PAGO VALUES(I_PAGO,IN_IDSERVICIO,IN_VALOR,IN_DESCRIPCION,IN_FECHA);
      COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/


-- EDITAR SERVICIO PAGO PENDIENTE 
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIOPE_W(IN_SERVICIO IN NUMBER,IN_ESTADO IN NUMBER,IN_PAGADO IN NUMBER,OUT_RESULTADO OUT VARCHAR2)AS

BEGIN 
  
    UPDATE SERVICIO SET ESTADO = IN_ESTADO
    WHERE ID_SERVICIO = IN_SERVICIO;
    
    UPDATE SERVICIO SET PAGADO = IN_PAGADO
     WHERE ID_SERVICIO = IN_SERVICIO;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/

-- EDITAR FINALIZAR VISITA

CREATE OR REPLACE PROCEDURE EDITAR_FIN_VISITA_W(IN_ACTIVIDAD IN NUMBER, IN_IDA IN NUMBER, OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/

-- CREAR CHECKLIST 

CREATE OR REPLACE PROCEDURE CREAR_CHECKLIST_V_W(IN_ACTIVIDAD IN NUMBER,IN_ARCHIVO IN VARCHAR2,
                                                IN_NOMBRE IN VARCHAR2,IN_DESCRIPCION IN VARCHAR2,
                                                IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
U_IDTA NUMBER := APP_USUARIO_SEGURIDAD.GET_TACTIVIDAD(IN_ACTIVIDAD);
I_CHEC NUMBER := ID_CHECKLIST.NEXTVAL;

BEGIN

INSERT INTO CHECKLIST VALUES(I_CHEC,U_IDTA,IN_ARCHIVO,IN_NOMBRE,IN_DESCRIPCION,IN_FECHA);
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;

END;
/


-- CREAR REPORTE 
CREATE OR REPLACE PROCEDURE CREAR_REPORTE_V_W(IN_ACTIVIDAD IN NUMBER,IN_ARCHIVO IN VARCHAR2,
                                                IN_NOMBRE IN VARCHAR2,IN_DESCRIPCION IN VARCHAR2,
                                                IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
U_IDTA NUMBER := APP_USUARIO_SEGURIDAD.GET_TACTIVIDAD(IN_ACTIVIDAD);
I_REPO NUMBER := ID_REPORTE.NEXTVAL;

BEGIN

INSERT INTO REPORTE VALUES(I_REPO,U_IDTA,IN_NOMBRE,IN_ARCHIVO,IN_DESCRIPCION,IN_FECHA);
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;

END;
/



-- CREAR ALERTA -- ACCIDENTE -- FISCALIZACION 

CREATE OR REPLACE PROCEDURE CREAR_ALERTA_AF_W(IN_USUARIO IN VARCHAR2, IN_NSERVICIO IN VARCHAR2, IN_DSERVICIO IN VARCHAR2, IN_VSERVICIO IN NUMBER,
                                              IN_PDESCRIPCION IN VARCHAR2, IN_PVALOR IN NUMBER,
                                              IN_NACTIVIDAD IN VARCHAR2, IN_DESCACTIVIDAD IN VARCHAR2,
                                              IN_ANOMBRE IN VARCHAR2, IN_ADESCRIPCION IN VARCHAR2, IN_FECHA IN DATE, IN_FECHA_S IN DATE, OUT_RESULTADO OUT VARCHAR2)AS
                                              
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);

I_SER NUMBER := ID_SERVICIO.NEXTVAL;
I_ACT NUMBER := ID_ACTIVIDAD.NEXTVAL;
I_TAC NUMBER := ID_TIPO_ACTIVIDAD.NEXTVAL;
I_ALE NUMBER := ID_ALERTA.NEXTVAL;
I_PAG NUMBER := ID_PAGO.NEXTVAL;

BEGIN

    --     ESTADO 1 : ACTIVO
    --            0 : DESHABILITADO 
    --            2 : REPROGRAMADO
    
    --    PAGADO 0 : NO PAGADO
    --           1 : PAGADO

INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NSERVICIO,IN_VSERVICIO,IN_DSERVICIO,IN_FECHA,IN_FECHA_S,1,1);
INSERT INTO PAGO VALUES(I_PAG,I_SER,IN_PVALOR,IN_PDESCRIPCION,IN_FECHA);

    --   ESTADO    1: CREADA
    --  ACTIVIDAD  2: EN PROGRESO  
    --             3: S/INFORME
    --             4: TERMINADA
    --             5: CANCELADA

INSERT INTO ACTIVIDAD VALUES(I_ACT,I_SER,IN_NACTIVIDAD,IN_DESCACTIVIDAD,1,IN_FECHA,IN_FECHA_S);
INSERT INTO TIPO_ACTIVIDAD VALUES(I_TAC,I_ACT,IN_NACTIVIDAD);

    -- ESTADO     1: CREADA 
    -- ALERTA     2: VISITA ACTIVA 
    --            3: FINALIZADA   
    --            4: CANCELADA

INSERT INTO ALERTA VALUES(I_ALE,I_TAC,IN_ANOMBRE,IN_ADESCRIPCION,1,IN_FECHA);

        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
END;
/

-- EDITAR ALERTA - EDITAR ACTIVIDAD X VISITA 

CREATE OR REPLACE PROCEDURE EDITAR_ACTIVIDAD_ALVI_W(IN_IDA IN NUMBER, IN_FECHAA IN DATE, IN_DESCRIPA IN VARCHAR2,OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET DESCRIPCION_ACTIVIDAD = IN_DESCRIPA
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE ACTIVIDAD SET FECHA_INICIO = IN_FECHAA
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE ACTIVIDAD SET FECHA_TERMINO = IN_FECHAA
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- EDITAR ALERTA VISITA

CREATE OR REPLACE PROCEDURE EDITAR_ALERTA_ALVI_W( IN_ALE IN NUMBER, IN_ESTADOA IN NUMBER,
                                                  OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ALERTA SET ESTADO = IN_ESTADOA
    WHERE ID_ALERTA = IN_ALE;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CANCELAR VISITA -- EDITAR ACTIVIDAD

CREATE OR REPLACE PROCEDURE EDITAR_CANCELAR_ALERTA_W(IN_ACTIVIDAD IN NUMBER, IN_IDA IN NUMBER,
                                                     IN_SERVICIO IN NUMBER, IN_IDS IN NUMBER, 
                                                     IN_ALERTA IN NUMBER, IN_IAL IN NUMBER,
                                                     OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE SERVICIO SET ESTADO = IN_SERVICIO
    WHERE ID_SERVICIO = IN_IDS;
    
    UPDATE ALERTA SET ESTADO = IN_ALERTA
    WHERE ID_ALERTA = IN_IAL;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- EDITAR SERVICIO 

CREATE OR REPLACE PROCEDURE EDITAR_ESTADO_SERVICIO_W(IN_SERVICIO IN NUMBER, IN_IDS IN NUMBER,OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE SERVICIO SET ESTADO = IN_SERVICIO
    WHERE ID_SERVICIO = IN_IDS;
   COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;

END;
/


-- CREAR ALERTA -- MEJORA

CREATE OR REPLACE PROCEDURE CREAR_MEJORA_W(IN_USUARIO IN VARCHAR2,IN_USUARIOP IN VARCHAR2, IN_NSERVICIO IN VARCHAR2, 
                                              IN_DSERVICIO IN VARCHAR2, IN_VSERVICIO IN NUMBER,
                                              IN_NACTIVIDAD IN VARCHAR2, IN_DESCACTIVIDAD IN VARCHAR2,
                                              IN_NMEJORA IN VARCHAR2, IN_DMEJORA IN VARCHAR2, IN_DARCHIVO IN VARCHAR2,
                                              IN_FECHA IN DATE, OUT_RESULTADO OUT VARCHAR2)AS
                                              
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
U_IDP NUMBER := APP_USUARIO_SEGURIDAD.GET_IDPROFESION(IN_USUARIOP);

I_SER NUMBER := ID_SERVICIO.NEXTVAL;
I_ACT NUMBER := ID_ACTIVIDAD.NEXTVAL;
I_TAC NUMBER := ID_TIPO_ACTIVIDAD.NEXTVAL;
I_MEJ NUMBER := ID_MEJORA.NEXTVAL;
I_APR NUMBER := ID_APROBACION.NEXTVAL;

BEGIN
    --     ESTADO 1 : ACTIVO
    --            0 : DESHABILITADO 
    --            2 : REPROGRAMADO
    
    --    PAGADO 0 : NO PAGADO
    --           1 : PAGADO

INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NSERVICIO,IN_VSERVICIO,IN_DSERVICIO,IN_FECHA,IN_FECHA,1,1);

    --   ESTADO    1: CREADA
    --  ACTIVIDAD  2: EN PROGRESO  
    --             3: S/INFORME
    --             4: TERMINADA
    --             5: CANCELADA

INSERT INTO ACTIVIDAD VALUES(I_ACT,I_SER,IN_NACTIVIDAD,IN_DESCACTIVIDAD,1,IN_FECHA,IN_FECHA);
INSERT INTO TIPO_ACTIVIDAD VALUES(I_TAC,I_ACT,IN_NACTIVIDAD);

    -- ESTADO     1: CREADA 
    -- MEJORA     2: FINALIZADA
    --            3: CANCELADA    
INSERT INTO MEJORA VALUES(I_MEJ,I_TAC,IN_NMEJORA,IN_DMEJORA,IN_DARCHIVO,1,IN_FECHA,IN_FECHA);

    -- ESTADO     1: NO APROBADA 
    -- APROBAR     2: APROBADA
    
INSERT INTO APROBAR VALUES(I_APR,U_IDP,I_MEJ,IN_NMEJORA,IN_DMEJORA,1,IN_FECHA); 
          
        COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
            ROLLBACK;
END;
/


-- CANCELAR MEJORA -- EDITAR

CREATE OR REPLACE PROCEDURE EDITAR_MEJORA_CANCEL_W(IN_IDA IN NUMBER,IN_ESTADOA IN NUMBER,IN_IDS IN NUMBER,IN_ESTADOS IN NUMBER,
                                                    IN_IDM IN NUMBER,IN_ESTADOM IN NUMBER,IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
BEGIN

    UPDATE ACTIVIDAD SET ESTADO = IN_ESTADOA
    WHERE ID_ACTIVIDAD = IN_IDA;
  
    UPDATE SERVICIO SET ESTADO = IN_ESTADOS 
    WHERE ID_SERVICIO = IN_IDS;
    
    UPDATE MEJORA SET ESTADO = IN_ESTADOM
    WHERE ID_MEJORA = IN_IDM;
    
    UPDATE MEJORA SET FECHA_TERMINO = IN_FECHA
    WHERE ID_MEJORA = IN_IDM;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- APROBAR MEJORA -- EDITAR
CREATE OR REPLACE PROCEDURE EDITAR_MEJORA_APROBAR_W(IN_IDA IN NUMBER,IN_ESTADOA IN NUMBER, 
                                                    IN_IDAP IN NUMBER, IN_ESTADOAP IN NUMBER,IN_USUARIOP IN VARCHAR2,
                                                    IN_IDM IN NUMBER,IN_ESTADOM IN NUMBER,IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
                                                    
U_IDP NUMBER := APP_USUARIO_SEGURIDAD.GET_IDPROFESION(IN_USUARIOP);    

BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ESTADOA
    WHERE ID_ACTIVIDAD = IN_IDA;
      
    UPDATE MEJORA SET ESTADO = IN_ESTADOM
    WHERE ID_MEJORA = IN_IDM;
    
    UPDATE MEJORA SET FECHA_TERMINO = IN_FECHA
    WHERE ID_MEJORA = IN_IDM;
    
    UPDATE APROBAR SET ID_PROFESION = U_IDP
    WHERE ID_APROBACION = IN_IDAP;
    
    UPDATE APROBAR SET ESTADO = IN_ESTADOAP
    WHERE ID_APROBACION = IN_IDAP;
    
    UPDATE APROBAR SET FECHA_APROBACION = IN_FECHA
    WHERE ID_APROBACION = IN_IDAP;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CREACION DE ACTIVIDAD,TIPO ACTIVIDAD,SERVICIO 
CREATE OR REPLACE PROCEDURE CREAR_ACTIVIDAD_CCHAT_W(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2,IN_NOMA IN VARCHAR2, IN_DESCRA IN VARCHAR2,IN_DESCP IN VARCHAR2,
                                                    IN_FECHAI IN DATE, IN_FECHAT IN DATE,IN_USUARIOP IN VARCHAR2, OUT_RESULTADO OUT VARCHAR2)AS

U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;
I_ACT NUMBER := ID_ACTIVIDAD.NEXTVAL;
I_TAC NUMBER := ID_TIPO_ACTIVIDAD.NEXTVAL;
I_PAG NUMBER := ID_PAGO.NEXTVAL;
I_INT NUMBER := ID_INTERACCION.NEXTVAL;
                                                    
BEGIN 
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : REPROGRAMADO
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,1);
    
    --ESTADO 1: CREADA
    --       2: EN PROGRESO  
    --       3: S/INFORME
    --       4: TERMINADA
    --       5: CANCELADA
    INSERT INTO ACTIVIDAD VALUES(I_ACT,I_SER,IN_NOMA,IN_DESCRA,1,IN_FECHAI,IN_FECHAT);
    INSERT INTO TIPO_ACTIVIDAD VALUES(I_TAC,I_ACT,IN_NOMA);
    INSERT INTO PAGO VALUES(I_PAG,I_SER,IN_VALORS,IN_DESCP,IN_FECHAI);
    INSERT INTO INTERACCION VALUES(I_INT,I_TAC,IN_USUARIOP,IN_FECHAI);
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;
END;
/


-- CERRAR CHAT -- EDITAR ACTIVIDAD

CREATE OR REPLACE PROCEDURE EDITAR_CERRAR_CHAT_W(IN_ACTIVIDAD IN NUMBER, IN_IDA IN NUMBER,IN_SERVICIO IN NUMBER, IN_IDS IN NUMBER, OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE SERVICIO SET ESTADO = IN_SERVICIO
    WHERE ID_SERVICIO = IN_IDS;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CANCELAR CAPACITACION -- EDITAR ACTIVIDAD

CREATE OR REPLACE PROCEDURE EDITAR_CANCELAR_CAPACITA_W(IN_ACTIVIDAD IN NUMBER, IN_IDA IN NUMBER,IN_SERVICIO IN NUMBER, IN_IDS IN NUMBER, OUT_RESULTADO OUT VARCHAR2)AS
BEGIN
    UPDATE ACTIVIDAD SET ESTADO = IN_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE SERVICIO SET ESTADO = IN_SERVICIO
    WHERE ID_SERVICIO = IN_IDS;
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
    EXCEPTION
        WHEN OTHERS THEN 
            OUT_RESULTADO := 'FALSE';
        ROLLBACK;
END;
/


-- CREAR INFORME -- CAPACITACION

CREATE OR REPLACE PROCEDURE CREAR_INFORME_C_W(IN_ACTIVIDAD IN NUMBER,IN_ARCHIVO IN VARCHAR2,
                                                IN_NOMBRE IN VARCHAR2,IN_DESCRIPCION IN VARCHAR2,
                                                IN_FECHA IN DATE,OUT_RESULTADO OUT VARCHAR2)AS
U_IDTA NUMBER := APP_USUARIO_SEGURIDAD.GET_TACTIVIDAD(IN_ACTIVIDAD);
I_INFO NUMBER := ID_INFORME.NEXTVAL;

BEGIN

INSERT INTO INFORME VALUES(I_INFO,U_IDTA,IN_NOMBRE,IN_ARCHIVO,IN_DESCRIPCION,IN_FECHA);
    
    COMMIT;
            OUT_RESULTADO := 'TRUE';
        EXCEPTION
            WHEN OTHERS THEN 
                OUT_RESULTADO := 'FALSE';
    ROLLBACK;

END;
/





-------------------------------------------------------------------------------------------------------------------------------

---------------------------   VERSION ESCRITORIO  ----------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------------------------------------

-- PERMITE CAMBIAR CONTRASE헤 
CREATE OR REPLACE PROCEDURE CAMBIAR_CONTRASE헤_E(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2)AS
    U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
    BEGIN
        UPDATE LOGIN SET CONTRASE헤_USUARIO = APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤)
        WHERE ID_TIPO_USUARIO = U_IDT;
        COMMIT;
    END;
/

-- PERMITE LA CREACION DE USUARIO DE MANERA GENERAL (USADO PARA ADMINISTRADORES)
CREATE OR REPLACE PROCEDURE CREAR_USUARIO_E(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, IN_TIPO IN VARCHAR2, IN_NOMBRE_USUARIO IN VARCHAR2,
                                                        IN_APELLIDO_USUARIO IN VARCHAR2, IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                        IN_DOMICILIO_USUARIO IN VARCHAR2) AS
    T_ID NUMBER := ID_TIPO_USUARIO_I.NEXTVAL;
    L_ID NUMBER := ID_LOGIN_I.NEXTVAL;
    BEGIN
        INSERT INTO USUARIO VALUES(IN_USUARIO,IN_NOMBRE_USUARIO,IN_APELLIDO_USUARIO,IN_TELEFONO_USUARIO,IN_CORREO_USUARIO,IN_DOMICILIO_USUARIO,1);
        INSERT INTO TIPO_USUARIO VALUES(T_ID,IN_USUARIO,IN_TIPO);
        INSERT INTO LOGIN VALUES(L_ID,APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤),T_ID);
        COMMIT;
    END;
/

-- PERMITE LA CREACION DE USUARIOS PROFESIONALES
CREATE OR REPLACE PROCEDURE CREAR_USUARIO_PROFESIONAL_E(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, IN_TIPO IN VARCHAR2, IN_NOMBRE_USUARIO IN VARCHAR2,
                                                        IN_APELLIDO_USUARIO IN VARCHAR2, IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                        IN_DOMICILIO_USUARIO IN VARCHAR2, IN_PROFESION IN VARCHAR2) AS
    T_ID NUMBER := ID_TIPO_USUARIO_I.NEXTVAL;
    L_ID NUMBER := ID_LOGIN_I.NEXTVAL;
    P_ID NUMBER := ID_TIPO_PROFESIONAL_I.NEXTVAL;
    BEGIN
        INSERT INTO USUARIO VALUES(IN_USUARIO,IN_NOMBRE_USUARIO,IN_APELLIDO_USUARIO,IN_TELEFONO_USUARIO,IN_CORREO_USUARIO,IN_DOMICILIO_USUARIO,1);
        INSERT INTO TIPO_USUARIO VALUES(T_ID,IN_USUARIO,IN_TIPO);
        INSERT INTO LOGIN VALUES(L_ID,APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤),T_ID);
        INSERT INTO PROFESION VALUES(P_ID,T_ID,IN_PROFESION);
        COMMIT;
    END;
/

-- PERMITE LA CREACION DE USUARIOS CLIENTES
CREATE OR REPLACE PROCEDURE CREAR_USUARIO_CLIENTE_E(IN_USUARIO IN VARCHAR2,IN_CONTRASE헤 IN VARCHAR2, IN_TIPO IN VARCHAR2, IN_NOMBRE_USUARIO IN VARCHAR2,
                                                  IN_APELLIDO_USUARIO IN VARCHAR2, IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                  IN_DOMICILIO_USUARIO IN VARCHAR2,
                                                  IN_RUT_EMPRESA IN VARCHAR2,IN_RAZON_SOCIAL IN VARCHAR2,
                                                  IN_DIRECCION IN VARCHAR2, IN_FONO IN NUMBER,IN_CORREO IN VARCHAR2,
                                                  IN_PAGINA_WEB IN VARCHAR2) AS
    T_ID NUMBER := ID_TIPO_USUARIO_I.NEXTVAL;
    L_ID NUMBER := ID_LOGIN_I.NEXTVAL;
    BEGIN
        INSERT INTO USUARIO VALUES(IN_USUARIO,IN_NOMBRE_USUARIO,IN_APELLIDO_USUARIO,IN_TELEFONO_USUARIO,IN_CORREO_USUARIO,IN_DOMICILIO_USUARIO,1);
        INSERT INTO TIPO_USUARIO VALUES(T_ID,IN_USUARIO,IN_TIPO);
        INSERT INTO LOGIN VALUES(L_ID,APP_USUARIO_SEGURIDAD.GET_HASH(IN_USUARIO,IN_CONTRASE헤),T_ID);
        INSERT INTO EMPRESA VALUES(IN_RUT_EMPRESA,T_ID,IN_USUARIO,IN_RAZON_SOCIAL,IN_DIRECCION,IN_FONO,IN_CORREO,IN_PAGINA_WEB);
        COMMIT;
    END;
/

-- PERMITE MODIFICAR DATOS DE EMPRESA DE USUARIO CLIENTE
CREATE OR REPLACE PROCEDURE MODIFICAR_USUARIO_CLIENTE_E_E(IN_USUARIO VARCHAR2, IN_R_SOCIAL IN VARCHAR2,IN_DIRECCION IN VARCHAR2,
                                                        IN_TELEFONO IN NUMBER, IN_CORREO IN VARCHAR2, 
                                                        IN_PAGINA_WEB IN VARCHAR2)AS
 BEGIN     
        UPDATE EMPRESA SET RAZON_SOCIAL_EMPRESA = IN_R_SOCIAL 
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET DIRECCION_EMPRESA = IN_DIRECCION
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET TELEFONO_EMPRESA = IN_TELEFONO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET CORREO_EMPRESA = IN_CORREO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE EMPRESA SET PAGINA_WEB_EMPRESA = IN_PAGINA_WEB
        WHERE RUT_USUARIO = IN_USUARIO;
        
        COMMIT;
    END;
/

-- PERMITE MODIFICAR DATOS DE USUARIOS
CREATE OR REPLACE PROCEDURE MODIFICAR_USUARIO_E(IN_USUARIO VARCHAR2, IN_NOMBRE IN VARCHAR2,IN_APELLIDO IN VARCHAR2,
                                                        IN_TELEFONO IN NUMBER, IN_CORREO IN VARCHAR2, 
                                                        IN_DOMICILIO IN VARCHAR2,IN_HABILITADO IN NUMBER)AS
 BEGIN     
        UPDATE USUARIO SET NOMBRE_USUARIO = IN_NOMBRE 
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET APELLIDO_USUARIO = IN_APELLIDO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET TELEFONO_USUARIO = IN_TELEFONO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET CORREO_USUARIO = IN_CORREO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET DOMICILIO_USUARIO = IN_DOMICILIO
        WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET HABILITADO = IN_HABILITADO
        WHERE RUT_USUARIO = IN_USUARIO;
        
        COMMIT;
    END;
/

-- PERMITE CAMBIAR EL ESTADO DE UN USUARIO 
CREATE OR REPLACE PROCEDURE MODIFICAR_ESTADO_USUARIO_E(IN_USUARIO IN VARCHAR2, IN_HABILITADO IN NUMBER)AS
 BEGIN     
        UPDATE USUARIO SET HABILITADO = IN_HABILITADO
        WHERE RUT_USUARIO = IN_USUARIO;
    END;
/


--

-- PERMITE MODIFICAR DATOS DE USUARIOS PROFESIONAL
CREATE OR REPLACE PROCEDURE MODIFICAR_USUARIO_PROFESION_E(IN_USUARIO VARCHAR2,IN_TELEFONO_USUARIO IN NUMBER,IN_CORREO_USUARIO IN VARCHAR2,
                                                        IN_DOMICILIO_USUARIO IN VARCHAR2)AS
 BEGIN     
        UPDATE USUARIO SET TELEFONO_USUARIO = IN_TELEFONO_USUARIO 
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET CORREO_USUARIO = IN_CORREO_USUARIO
            WHERE RUT_USUARIO = IN_USUARIO;
         UPDATE USUARIO SET DOMICILIO_USUARIO = IN_DOMICILIO_USUARIO
            WHERE RUT_USUARIO = IN_USUARIO;
        COMMIT;
    END;
/



-- CREACION DE CONTRATO 
CREATE OR REPLACE PROCEDURE CREAR_CONTRATO_E(IN_USUARIO IN VARCHAR2,IN_FECHAC IN DATE,IN_PLAZO IN VARCHAR2,IN_VALOR IN NUMBER) AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := ID_FOLIO_CONTRATO.NEXTVAL;
BEGIN 
    --ESTADO 0 : NO PAGADO 
    --       1 : ACTIVO
    --       2 : DESHABILITADO
    
    --MODIFICADO 0 : NO MODIFICADO
    --           1 : MODIFICADO
    INSERT INTO CONTRATO VALUES(F_CON,U_IDT,IN_FECHAC,IN_PLAZO,IN_VALOR,0,0);
    COMMIT;   
END;
/

-- CREACION DE SERVICIO DE TIPO CONTRATO
CREATE OR REPLACE PROCEDURE CREAR_SERVICIO_CONTRATO_E(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2,IN_FECHAI IN DATE, IN_FECHAT IN DATE)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;

BEGIN 
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,0);
    COMMIT;
END;
/

-- CREACION DE FONDO MONETARIO 
CREATE OR REPLACE PROCEDURE CREAR_FONDO_MONETARIO_E(IN_USUARIO IN VARCHAR2,IN_MONTO IN NUMBER, IN_FECHA_ABONO IN DATE)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
ID_FONDO NUMBER := ID_FONDO_MONETARIO.NEXTVAL;

BEGIN
    INSERT INTO FONDO_MONETARIO VALUES(ID_FONDO,F_CON,IN_MONTO,IN_FECHA_ABONO);
    COMMIT;  
END;
/


-- EDITAR ESTADO CONTRATO X USUARIO
CREATE OR REPLACE PROCEDURE EDITAR_ESTADO_CONTRATOU_E(IN_USUARIO IN VARCHAR2,IN_MODIFICADO IN NUMBER,IN_ESTADO IN NUMBER)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);

BEGIN
    UPDATE CONTRATO SET MODIFICADO = IN_MODIFICADO
    WHERE FOLIO_CONTRATO = F_CON; 
    UPDATE CONTRATO SET ESTADO = IN_ESTADO
    WHERE FOLIO_CONTRATO = F_CON; 
    COMMIT;
    
END;
/

-- EDITAR SERVICIO
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIO_E(IN_ID_SERVICIO IN NUMBER,IN_FECHAT IN DATE, IN_ESTADO IN NUMBER,IN_PAGADO IN NUMBER)AS
BEGIN 
	--ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    UPDATE SERVICIO SET FECHA_TERMINO = IN_FECHAT
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    
    UPDATE SERVICIO SET ESTADO = IN_ESTADO
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    
    UPDATE SERVICIO SET PAGADO = IN_PAGADO
    WHERE ID_SERVICIO = IN_ID_SERVICIO;  
    COMMIT;
    
END;
/

-- EDITAR ACTIVIDAD - FORZAR CIERRE 
CREATE OR REPLACE PROCEDURE EDITAR_ACTIVIDAD_E(IN_ID_ACTIVIDAD IN NUMBER, IN_ESTADO IN NUMBER)AS
BEGIN 
	--ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 	
    UPDATE ACTIVIDAD SET ESTADO = IN_ESTADO
    WHERE ID_SERVICIO = IN_ID_ACTIVIDAD;
    COMMIT;
END;
/

-- PERMITE VALIDAR USUARIO EXISTENTE POR - RUT 
CREATE OR REPLACE PROCEDURE VALIDAR_USUARIO_RUT_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
      	SELECT COUNT(*) 
		INTO EXISTE
		FROM USUARIO
		WHERE RUT_USUARIO = IN_USUARIO;
		OUT_RESULTADO := EXISTE;    
END;
/

-- PERMITE VALIDAR USUARIO - EMPRESA EXISTENTE POR - RUT 
CREATE OR REPLACE PROCEDURE VALIDAR_USUARIO_RUT_E_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
      	SELECT COUNT(*) 
		INTO EXISTE
		FROM EMPRESA
		WHERE RUT_EMPRESA = IN_USUARIO;
		OUT_RESULTADO := EXISTE;    
END;
/

-- PERMITE VALIDAR USUARIO - HABILITADO
CREATE OR REPLACE PROCEDURE VALIDAR_USUARIO_HAB_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
      	SELECT COUNT(*) 
		INTO EXISTE
		FROM USUARIO
		WHERE RUT_USUARIO = IN_USUARIO AND HABILITADO = 0;
		OUT_RESULTADO := EXISTE;     
END;
/

-- PERMITE VALIDAR EL CONTRATO RUT - TIPO USUARIO
CREATE OR REPLACE PROCEDURE VALIDAR_CONTRATO_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
      	SELECT COUNT(*) 
		INTO EXISTE
		FROM CONTRATO C JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO =  T.ID_TIPO_USUARIO
						JOIN USUARIO U ON U.RUT_USUARIO = T.RUT_USUARIO
		WHERE  U.RUT_USUARIO = IN_USUARIO AND C.ID_TIPO_USUARIO =  T.ID_TIPO_USUARIO;
		OUT_RESULTADO := EXISTE;    
END;
/


-- PERMITE VALIDAR EL FONDO MONETARIO RUT - TIPO USUARIO
CREATE OR REPLACE PROCEDURE VALIDAR_FMONETARIO_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
		SELECT COUNT(*) 
		INTO EXISTE
		FROM  FONDO_MONETARIO FM JOIN CONTRATO C ON FM.ID_FONDO = C.FOLIO_CONTRATO
                                 JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO =  T.ID_TIPO_USUARIO
                                 JOIN USUARIO U ON U.RUT_USUARIO = T.RUT_USUARIO
		WHERE  U.RUT_USUARIO = IN_USUARIO AND C.FOLIO_CONTRATO =  FM.ID_FONDO;
		OUT_RESULTADO := EXISTE;    
END;
/

-- PERMITE VALIDAR EL ESTADO DE CONTRATO RUT - TIPO USUARIO - FOLIO
CREATE OR REPLACE PROCEDURE VALIDAR_ESTADO_CONTRATO_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
      	SELECT COUNT (*)
		INTO EXISTE
		FROM SERVICIO S JOIN CONTRATO C ON  S.ID_SERVICIO= C.FOLIO_CONTRATO
						JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
						JOIN USUARIO U ON U.RUT_USUARIO = T.RUT_USUARIO
		WHERE U.RUT_USUARIO = IN_USUARIO AND C.FOLIO_CONTRATO = S.FOLIO_CONTRATO AND C.ESTADO = 0;  
		OUT_RESULTADO := EXISTE; 
END;
/

-- EDITAR CONTRATO - ESTADO - DESHABILITADO
CREATE OR REPLACE PROCEDURE EDITAR_CONTRATO_E_E(IN_FOLIO_CONTRATO IN NUMBER)AS
BEGIN 
	--ESTADO 0 : NO PAGADO 
    --       1 : ACTIVO
    --       2 : DESHABILITADO
	
    UPDATE CONTRATO SET ESTADO = 2
    WHERE FOLIO_CONTRATO = IN_FOLIO_CONTRATO;
    COMMIT;
END;
/

-- EDITAR CONTRATO - ESTADO - ACTIVO
CREATE OR REPLACE PROCEDURE EDITAR_CONTRATO_E_A_E(IN_FOLIO_CONTRATO IN NUMBER)AS
BEGIN 
	--ESTADO 0 : NO PAGADO 
    --       1 : ACTIVO
    --       2 : DESHABILITADO
	
    UPDATE CONTRATO SET ESTADO = 1
    WHERE FOLIO_CONTRATO = IN_FOLIO_CONTRATO;
    COMMIT;
END;
/


-- EDITAR ACTIVIDAD - ESTADO - DESHABILITADO
CREATE OR REPLACE PROCEDURE EDITAR_ACTIVIDAD_E_E(IN_ID_ACTIVIDAD IN NUMBER)AS
BEGIN 
	--ESTADO 1: CREADA
    --       2: EN PROGRESO  
    --       3: TERMINADA
    --       4: CANCELADA
    UPDATE ACTIVIDAD SET ESTADO = 4
    WHERE ID_ACTIVIDAD = IN_ID_ACTIVIDAD;
    COMMIT;
END;
/

-- EDITAR ACTIVIDAD - ESTADO - CREADA
CREATE OR REPLACE PROCEDURE EDITAR_ACTIVIDAD_E_C_E(IN_ID_ACTIVIDAD IN NUMBER)AS
BEGIN 
	--ESTADO 1: CREADA
    --       2: EN PROGRESO  
    --       3: TERMINADA
    --       4: CANCELADA
    UPDATE ACTIVIDAD SET ESTADO = 1
    WHERE ID_ACTIVIDAD = IN_ID_ACTIVIDAD;
    COMMIT;
END;
/

-- EDITAR SERVICIO - ESTADO - DESHABILITADO
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIO_E_E(IN_ID_SERVICIO IN NUMBER)AS
BEGIN 
	--ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : EDITADA
    UPDATE SERVICIO SET ESTADO = 0
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    COMMIT;
END;
/

-- EDITAR SERVICIO - ESTADO - ACTIVO
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIO_E_A_E(IN_ID_SERVICIO IN NUMBER)AS
BEGIN 
	--ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : EDITADA
    UPDATE SERVICIO SET ESTADO = 1
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    COMMIT;
END;
/

-- PERMITE VALIDAR SI EL ESTADO - CONTRATO ESTA HABILITADO
CREATE OR REPLACE PROCEDURE VALIDAR_ESTADO_SERVICIO_H_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
	--ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : EDITADA
      	SELECT COUNT (*)
		INTO EXISTE
		FROM SERVICIO S JOIN CONTRATO C ON  S.ID_SERVICIO= C.FOLIO_CONTRATO
						JOIN TIPO_USUARIO T ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
						JOIN USUARIO U ON U.RUT_USUARIO = T.RUT_USUARIO
		WHERE U.RUT_USUARIO = IN_USUARIO AND C.FOLIO_CONTRATO = S.FOLIO_CONTRATO AND S.ESTADO = 1;  
		OUT_RESULTADO := EXISTE; 
END;
/

-- EDITAR SERVICIO - PAGADO - DESHABILITADO
CREATE OR REPLACE PROCEDURE EDITAR_SERVICIO_P_E(IN_ID_SERVICIO IN NUMBER)AS
BEGIN 
	--ESTADO 0 : NO PAGADO 
    --       1 : ACTIVO
    --       2 : DESHABILITADO
	
    UPDATE SERVICIO SET PAGADO = 1
    WHERE ID_SERVICIO = IN_ID_SERVICIO;
    COMMIT;
END;
/


-- DATOS ESTADISTICA - RUT USUARIO - VALOR TOTAL PAGO
CREATE OR REPLACE PROCEDURE DATOS_ESTADISTICA_E(OUT_CURSOR_ESTADISTICA OUT SYS_REFCURSOR) AS
RUT_USER USUARIO.RUT_USUARIO%TYPE;
VAL_TOTAL PAGO.VALOR_TOTAL%TYPE;
BEGIN
OPEN OUT_CURSOR_ESTADISTICA FOR
SELECT U.RUT_USUARIO, SUM(P.VALOR_TOTAL) AS "PAGO TOTAL DE SERVICIO "
INTO RUT_USER,VAL_TOTAL
FROM PAGO P    JOIN SERVICIO  S       ON P.ID_PAGO = S.ID_SERVICIO     
               JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
               JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
               JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO
GROUP BY U.RUT_USUARIO;     
END;
/

-- DATOS ESTADISTICA - RUT USUARIO - ACTIVIDAD ENTRE FECHA JULIO
CREATE OR REPLACE PROCEDURE DATOS_ESTADISTICA_1E(OUT_CURSOR_ESTADISTICA OUT SYS_REFCURSOR) AS
RUT_USER USUARIO.RUT_USUARIO%TYPE;
R_FECHA ACTIVIDAD.FECHA_INICIO%TYPE;
BEGIN
OPEN OUT_CURSOR_ESTADISTICA FOR
SELECT U.RUT_USUARIO,A.FECHA_INICIO
INTO RUT_USER,R_FECHA
FROM  TIPO_ACTIVIDAD TA JOIN ACTIVIDAD A       ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                        JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO
                        JOIN PAGO P            ON S.ID_SERVICIO = P.ID_PAGO
                        JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                        JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                        JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO               
WHERE A.FECHA_INICIO BETWEEN '01/06/2020'AND '31/07/2020'; 
END;
/     


-- DATOS ESTADISTICA - RUT EMPRESA - ACTIVIDAD ENTRE FECHA JULIO
CREATE OR REPLACE PROCEDURE DATOS_ESTADISTICA_2E(OUT_CURSOR_ESTADISTICA OUT SYS_REFCURSOR) AS
RUT_USER EMPRESA.RUT_EMPRESA%TYPE;
R_FECHA ACTIVIDAD.FECHA_INICIO%TYPE;
BEGIN
OPEN OUT_CURSOR_ESTADISTICA FOR
SELECT E.RUT_EMPRESA,A.FECHA_INICIO
INTO RUT_USER,R_FECHA
FROM TIPO_ACTIVIDAD TA JOIN ACTIVIDAD A       ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                        JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO
                        JOIN PAGO P            ON S.ID_SERVICIO = P.ID_PAGO
                        JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                        JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                        JOIN EMPRESA E         ON T.ID_TIPO_USUARIO = E.ID_TIPO_USUARIO
WHERE T.ID_TIPO_USUARIO = C.ID_TIPO_USUARIO AND C.FOLIO_CONTRATO = S.FOLIO_CONTRATO 
       AND S.ID_SERVICIO = A.ID_SERVICIO
       AND A.FECHA_INICIO BETWEEN '01/06/2020'AND '31/07/2020';
END;
/     


-- DATOS ESTADISTICA - CANTIDAD DE USUARIOS - FECHA CONTRATO
CREATE OR REPLACE PROCEDURE DATOS_ESTADISTICA_3E(OUT_CURSOR_ESTADISTICA OUT SYS_REFCURSOR) AS
RUT_USER USUARIO.RUT_USUARIO%TYPE;
FECHA CONTRATO.FECHA_CONTRATO%TYPE;
BEGIN
OPEN OUT_CURSOR_ESTADISTICA FOR
SELECT COUNT(U.RUT_USUARIO),C.FECHA_CONTRATO
INTO RUT_USER,FECHA
FROM CONTRATO C JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO
WHERE C.FECHA_CONTRATO BETWEEN '01/06/2020'AND '31/07/2020'
GROUP BY C.FECHA_CONTRATO;
 
END;
/



-- CREACION PROCEDIMIENTO INFORMACION PARA INFORME PDF
CREATE OR REPLACE PROCEDURE DATA_INFORME_PDF(IN_USUARIO IN VARCHAR2,OUT_CURSOR_PDF OUT SYS_REFCURSOR)AS
U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
BEGIN
OPEN OUT_CURSOR_PDF FOR
SELECT U.RUT_USUARIO,U.NOMBRE_USUARIO,U.APELLIDO_USUARIO,U.TELEFONO_USUARIO,
        U.CORREO_USUARIO,U.DOMICILIO_USUARIO,
        C.FOLIO_CONTRATO,C.FECHA_CONTRATO,C.PLAZO_CONTRATO,C.MONTO_PAGO,
        S.NOMBRE_SERVICIO,S.VALOR_SERVICIO,S.DESCRIPCION_SERVICIO,S.FECHA_INICIO,S.FECHA_TERMINO,
        P.ID_PAGO,P.VALOR_TOTAL,P.DESCRIPCION,P.FECHA_PAGO,
        A.NOMBRE_ACTIVIDAD,A.DESCRIPCION_ACTIVIDAD,A.FECHA_INICIO,A.FECHA_TERMINO,
        R.ID_REPORTE,R.NOMBRE_REPORTE,R.ARCHIVO,R.DESCRIPCION_REPORTE,R.FECHA_EMISION      
FROM REPORTE R    JOIN TIPO_ACTIVIDAD TA ON R.ID_REPORTE = TA.ID_TIPO_ACTIVIDAD
                  JOIN ACTIVIDAD A       ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
                  JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO   
                  JOIN PAGO P            ON S.ID_SERVICIO = P.ID_PAGO
                  JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
                  JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
                  JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO  
WHERE TA.NOMBRE_TIPO_ACTIVIDAD = 'Visita' AND U.RUT_USUARIO = IN_USUARIO;  
END;
/


-- PERMITE VALIDAR RUT USUARIO & REPORTE - TIPO_ACTIVIDAD 
CREATE OR REPLACE PROCEDURE VALIDAR_REPORTE_E(IN_USUARIO IN VARCHAR2, OUT_RESULTADO OUT NUMBER)AS
EXISTE NUMBER;
BEGIN
      	SELECT COUNT(*) 
		INTO EXISTE
		FROM REPORTE R    JOIN TIPO_ACTIVIDAD TA ON R.ID_REPORTE = TA.ID_TIPO_ACTIVIDAD
						  JOIN ACTIVIDAD A       ON TA.ID_TIPO_ACTIVIDAD = A.ID_ACTIVIDAD
						  JOIN SERVICIO  S       ON A.ID_ACTIVIDAD = S.ID_SERVICIO     
						  JOIN CONTRATO  C       ON C.FOLIO_CONTRATO = S.FOLIO_CONTRATO
						  JOIN TIPO_USUARIO T    ON C.ID_TIPO_USUARIO = T.ID_TIPO_USUARIO
						  JOIN USUARIO U         ON T.RUT_USUARIO = U.RUT_USUARIO
		WHERE  U.RUT_USUARIO = IN_USUARIO
						 AND TA.ID_ACTIVIDAD   =  R.ID_TIPO_ACTIVIDAD;
		OUT_RESULTADO := EXISTE;      
END;
/

--CREAR DE ACTIVIDAD - TIPO ACTIVIDAD - SERVICIO 
CREATE OR REPLACE PROCEDURE CREAR_ACTIVIDAD_COMPLETA_E(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2,IN_NOMA IN VARCHAR2, IN_DESCRA IN VARCHAR2,IN_DESCP IN VARCHAR2,
                                                    IN_FECHAI IN DATE, IN_FECHAT IN DATE)AS

U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;
I_ACT NUMBER := ID_ACTIVIDAD.NEXTVAL;
I_TAC NUMBER := ID_TIPO_ACTIVIDAD.NEXTVAL;
I_PAG NUMBER := ID_PAGO.NEXTVAL;
                                                    
BEGIN 
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : REPROGRAMADO
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,1);
    
    --ESTADO 1: CREADA
    --       2: EN PROGRESO  
    --       3: S/INFORME
    --       4: TERMINADA
    --       5: CANCELADA
    INSERT INTO ACTIVIDAD VALUES(I_ACT,I_SER,IN_NOMA,IN_DESCRA,1,IN_FECHAI,IN_FECHAT);
    INSERT INTO TIPO_ACTIVIDAD VALUES(I_TAC,I_ACT,IN_NOMA);
    INSERT INTO PAGO VALUES(I_PAG,I_SER,IN_VALORS,IN_DESCP,IN_FECHAI);
    COMMIT;
END;
/


-- EDITAR VISITA FECHA - ESTADO X ID'S 
CREATE OR REPLACE PROCEDURE EDITAR_FECHA_VISITA_E(IN_IDA IN NUMBER,IN_IDS IN NUMBER, IN_ESTADOS IN NUMBER,IN_FECHA_I IN DATE,IN_FECHA_T IN DATE)AS
BEGIN

    UPDATE ACTIVIDAD SET FECHA_INICIO = IN_FECHA_I
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE ACTIVIDAD SET FECHA_TERMINO = IN_FECHA_T
    WHERE ID_ACTIVIDAD = IN_IDA;
    
    UPDATE SERVICIO SET ESTADO = IN_ESTADOS 
    WHERE ID_SERVICIO = IN_IDS;
    
    COMMIT;
END;
/


-- ELIMINA VISITA X ID
CREATE OR REPLACE PROCEDURE ELIMINAR_VISITA_E(IN_IDA IN NUMBER)AS
BEGIN
	DELETE FROM TIPO_ACTIVIDAD
    WHERE ID_ACTIVIDAD = IN_IDA AND NOMBRE_TIPO_ACTIVIDAD = 'Visita';
    
    DELETE FROM ACTIVIDAD   
	WHERE ID_ACTIVIDAD = IN_IDA;
    
    DELETE FROM PAGO
    WHERE ID_SERVICIO = IN_IDA;
                         
    DELETE FROM SERVICIO
    WHERE ID_SERVICIO = IN_IDA;
COMMIT;
END;
/


--CREAR DE ACTIVIDAD - TIPO ACTIVIDAD - SERVICIO 
CREATE OR REPLACE PROCEDURE CREAR_ACTIVIDAD_COMPLETA_R(IN_USUARIO IN VARCHAR2,IN_NOMBRES IN VARCHAR2,IN_VALORS IN NUMBER, 
                                                    IN_DESCS IN VARCHAR2,IN_NOMA IN VARCHAR2, IN_DESCRA IN VARCHAR2,IN_DESCP IN VARCHAR2,
                                                    IN_FECHAI IN DATE, IN_FECHAT IN DATE,IN_NOM_REPORTE IN VARCHAR2,IN_ARCH IN VARCHAR2,IN_DESC_R IN VARCHAR2,IN_DATE_EMISION IN DATE)AS

U_IDT NUMBER := APP_USUARIO_SEGURIDAD.GET_IDT(IN_USUARIO);
F_CON NUMBER := APP_USUARIO_SEGURIDAD.GET_FOLIO(U_IDT);
I_SER NUMBER := ID_SERVICIO.NEXTVAL;
I_ACT NUMBER := ID_ACTIVIDAD.NEXTVAL;
I_TAC NUMBER := ID_TIPO_ACTIVIDAD.NEXTVAL;
I_PAG NUMBER := ID_PAGO.NEXTVAL;
ID_REP NUMBER := ID_REPORTE.NEXTVAL;
--ID_T_ACTI NUMBER:= ID_TIPO_ACTIVIDAD.NEXTVAL;
                                                    
BEGIN 	
    --ESTADO 1 : ACTIVO
    --       0 : DESHABILITADO 
    --       2 : REPROGRAMADO
    
    --PAGADO 0 : NO PAGADO
    --       1 : PAGADO
    INSERT INTO SERVICIO VALUES(I_SER,F_CON,IN_NOMBRES,IN_VALORS,IN_DESCS,IN_FECHAI,IN_FECHAT,1,1);
    
    --ESTADO 1: CREADA
    --       2: EN PROGRESO  
    --       3: S/INFORME
    --       4: TERMINADA
    --       5: CANCELADA
    INSERT INTO ACTIVIDAD VALUES(I_ACT,I_SER,IN_NOMA,IN_DESCRA,1,IN_FECHAI,IN_FECHAT);
    INSERT INTO TIPO_ACTIVIDAD VALUES(I_TAC,I_ACT,IN_NOMA);
	INSERT INTO REPORTE VALUES(ID_REP,I_TAC,IN_NOM_REPORTE,IN_ARCH,IN_DESC_R,IN_DATE_EMISION);
    INSERT INTO PAGO VALUES(I_PAG,I_SER,IN_VALORS,IN_DESCP,IN_FECHAI);
    COMMIT;
END;
/


-- ROTORNA VALORES Y CALCULO DE ACCIDENTABILIDAD
CREATE OR REPLACE PROCEDURE CAL_ACCIDEN(V_T_EMPLEADOS OUT NUMBER,V_T_ACCIDENT OUT NUMBER,V_RESUL_ACCIDEN OUT VARCHAR2) IS
BEGIN
    SELECT COUNT(RUT_USUARIO) AS "CANTIDAD DE EMPLEADOS"
    INTO V_T_EMPLEADOS
    FROM USUARIO;
    
    SELECT COUNT(NOMBRE_TIPO_ACTIVIDAD) AS "CANTIDAD DE ACCIDENTES"
    INTO V_T_ACCIDENT
    FROM TIPO_ACTIVIDAD
    WHERE NOMBRE_TIPO_ACTIVIDAD = 'Accidente';
     -- NDE ACCIDENTES * 100 / POR EL NDE EMPLEADOS = EN %
    V_RESUL_ACCIDEN :=  TRUNC(V_T_ACCIDENT * 100 / V_T_EMPLEADOS);
    V_RESUL_ACCIDEN := 'RESULTADO ACCIDENTABILIDAD : '|| V_RESUL_ACCIDEN ||'%';
END;
/


-- CREACION DE USUARIOS ADMINISTRADORES
EXEC CREAR_USUARIO_E('19319039-1','admin','Administrador','Luis Eduardo','Berrios A.',972075322,'l.berriosa@alumnos.duoc.cl','camino el alto #16420');
EXEC CREAR_USUARIO_E('19438678-8','admin','Administrador','Pedro Pablo','Marambio V.',993390033,'pe.marambio@alumnos.duoc.cl','camino el alba #12323');


